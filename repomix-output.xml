This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.dockerignore
.gitignore
ApiGateway/ApiGateway.sln
ApiGateway/ApiGateway/ApiGateway.csproj
ApiGateway/ApiGateway/ApiGateway.http
ApiGateway/ApiGateway/appsettings.Development.json
ApiGateway/ApiGateway/appsettings.json
ApiGateway/ApiGateway/Program.cs
ApiGateway/ApiGateway/Properties/launchSettings.json
deploy/docker/ApiGateway.Dockerfile
deploy/docker/DriverService.Dockerfile
deploy/docker/TripService.Dockerfile
deploy/docker/UserService.Dockerfile
docker-compose.yml
DriverService/DriverService.Api/appsettings.Development.json
DriverService/DriverService.Api/appsettings.json
DriverService/DriverService.Api/Controllers/DriversController.cs
DriverService/DriverService.Api/DriverService.Api.csproj
DriverService/DriverService.Api/DriverService.Api.http
DriverService/DriverService.Api/Grpc/DriverQueryService.cs
DriverService/DriverService.Api/Messaging/TripAssignedConsumer.cs
DriverService/DriverService.Api/Messaging/TripCreatedConsumer.cs
DriverService/DriverService.Api/Messaging/TripRequestedConsumer.cs
DriverService/DriverService.Api/Program.cs
DriverService/DriverService.Api/Properties/launchSettings.json
DriverService/DriverService.Application/Abstractions/IDriverRepository.cs
DriverService/DriverService.Application/Abstractions/IDriverService.cs
DriverService/DriverService.Application/DriverService.Application.csproj
DriverService/DriverService.Application/Protos/driver.proto
DriverService/DriverService.Application/Services/DriverLocationService.cs
DriverService/DriverService.Application/Services/DriverService.cs
DriverService/DriverService.Domain/DriverService.Domain.csproj
DriverService/DriverService.Domain/Entities/Driver.cs
DriverService/DriverService.Domain/ValueObjects/GeoPoint.cs
DriverService/DriverService.Infrastructure/Data/DriverDbContext.cs
DriverService/DriverService.Infrastructure/DriverService.Infrastructure.csproj
DriverService/DriverService.Infrastructure/Migrations/20251101135748_Initial Create.cs
DriverService/DriverService.Infrastructure/Migrations/20251101135748_Initial Create.Designer.cs
DriverService/DriverService.Infrastructure/Migrations/DriverDbContextModelSnapshot.cs
DriverService/DriverService.Infrastructure/Repositories/EfDriverRepository.cs
DriverService/DriverService.sln
LICENSE
Message/Message.sln
Message/Messaging.Contracts/Abstractions/IIntergrationCommand.cs
Message/Messaging.Contracts/Abstractions/IIntergrationEvent.cs
Message/Messaging.Contracts/Abstractions/IIntergrationMessage.cs
Message/Messaging.Contracts/Common/GeoPoint.cs
Message/Messaging.Contracts/Drivers/DriverAssignedToTrip.cs
Message/Messaging.Contracts/Drivers/DriverLocationUpdated.cs
Message/Messaging.Contracts/Drivers/DriverStatusChanged.cs
Message/Messaging.Contracts/Messaging.Contracts.csproj
Message/Messaging.Contracts/Routing/Routing.cs
Message/Messaging.Contracts/Trips/TripAccepted.cs
Message/Messaging.Contracts/Trips/TripAssigned.cs
Message/Messaging.Contracts/Trips/TripCanceled.cs
Message/Messaging.Contracts/Trips/TripCreated.cs
Message/Messaging.Contracts/Trips/TripOfferDeclined.cs
Message/Messaging.Contracts/Trips/TripOffered.cs
Message/Messaging.Contracts/Trips/TripRequested.cs
Message/Messaging.RabbitMQ/Abstractions/IEventPublisher.cs
Message/Messaging.RabbitMQ/Abstractions/IRabbitConsumer.cs
Message/Messaging.RabbitMQ/Config/RabbitMqOptions.cs
Message/Messaging.RabbitMQ/Infrastructure/BaseRabbitConsumer.cs
Message/Messaging.RabbitMQ/Infrastructure/JsonSerializerSettings.cs
Message/Messaging.RabbitMQ/Infrastructure/RabbitMqPublisher.cs
Message/Messaging.RabbitMQ/Messaging.RabbitMQ.csproj
Message/Messaging.RabbitMQ/ServiceCollectionExtensions.cs
nginx_gateway/nginx.conf
nginx_gateway/Nginx.Dockerfile
README.md
Shared/Shared.sln
Shared/Shared/GeoUtils.cs
Shared/Shared/Shared.csproj
TripService/TripService.Api/appsettings.Development.json
TripService/TripService.Api/appsettings.json
TripService/TripService.Api/Controllers/TripsController.cs
TripService/TripService.Api/Messaging/TripOfferDeclinedConsumer.cs
TripService/TripService.Api/Messaging/TripOfferedConsumer.cs
TripService/TripService.Api/Program.cs
TripService/TripService.Api/Properties/launchSettings.json
TripService/TripService.Api/TripService.Api.csproj
TripService/TripService.Api/TripService.Api.http
TripService/TripService.Application/Abstractions/IOfferStore.cs
TripService/TripService.Application/Abstractions/ITripRepository.cs
TripService/TripService.Application/Abstractions/ITripService.cs
TripService/TripService.Application/Offers/RedisOfferStore.cs
TripService/TripService.Application/Protos/driver.proto
TripService/TripService.Application/Services/TripMatchService.cs
TripService/TripService.Application/Services/TripService.cs
TripService/TripService.Application/TripService.Application.csproj
TripService/TripService.Domain/Entities/Trip.cs
TripService/TripService.Domain/TripService.Domain.csproj
TripService/TripService.Infrastructure/Data/TripDbContext.cs
TripService/TripService.Infrastructure/Migrations/20251101134456_Initial Create.cs
TripService/TripService.Infrastructure/Migrations/20251101134456_Initial Create.Designer.cs
TripService/TripService.Infrastructure/Migrations/20251102140556_change trip attributes.cs
TripService/TripService.Infrastructure/Migrations/20251102140556_change trip attributes.Designer.cs
TripService/TripService.Infrastructure/Migrations/TripDbContextModelSnapshot.cs
TripService/TripService.Infrastructure/Repositories/EfTripRepository.cs
TripService/TripService.Infrastructure/TripService.Infrastructure.csproj
TripService/TripService.sln
UserService/UserService.Api/appsettings.Development.json
UserService/UserService.Api/appsettings.json
UserService/UserService.Api/Controllers/AuthController.cs
UserService/UserService.Api/Program.cs
UserService/UserService.Api/Properties/launchSettings.json
UserService/UserService.Api/UserService.Api.csproj
UserService/UserService.Api/UserService.Api.http
UserService/UserService.Application/Abstractions/IAuthService.cs
UserService/UserService.Application/Abstractions/IJwtTokenProvider.cs
UserService/UserService.Application/Abstractions/IUserRepository.cs
UserService/UserService.Application/Dtos/LoginDto.cs
UserService/UserService.Application/Dtos/RegisterDto.cs
UserService/UserService.Application/Services/AuthService.cs
UserService/UserService.Application/UserService.Application.csproj
UserService/UserService.Domain/Entities/User.cs
UserService/UserService.Domain/UserService.Domain.csproj
UserService/UserService.Infrastructure/Auth/JwtSettings.cs
UserService/UserService.Infrastructure/Auth/JwtTokenProvider.cs
UserService/UserService.Infrastructure/Data/UserDbContext.cs
UserService/UserService.Infrastructure/Migrations/20251101140406_Initial Create.cs
UserService/UserService.Infrastructure/Migrations/20251101140406_Initial Create.Designer.cs
UserService/UserService.Infrastructure/Migrations/UserDbContextModelSnapshot.cs
UserService/UserService.Infrastructure/Repositories/EfUserRepository.cs
UserService/UserService.Infrastructure/UserService.Infrastructure.csproj
UserService/UserService.sln
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="Message/Messaging.Contracts/Trips/TripOfferDeclined.cs">
using Messaging.Contracts.Abstractions;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.Contracts.Trips
{
    public sealed record TripOfferDeclined(
    Guid TripId,
    Guid DriverId
) : IIntegrationEvent
    {
        public Guid MessageId { get; init; } = Guid.NewGuid();
        public DateTime OccurredAtUtc { get; init; } = DateTime.UtcNow;
        public string? CorrelationId { get; init; }
        public string? CausationId { get; init; }
    }
}
</file>

<file path="Message/Messaging.Contracts/Trips/TripOffered.cs">
using Messaging.Contracts.Abstractions;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.Contracts.Trips
{
    public sealed record TripOffered(
    Guid TripId,
    Guid DriverId,
    int TtlSeconds
) : IIntegrationEvent
    {
        public Guid MessageId { get; init; } = Guid.NewGuid();
        public DateTime OccurredAtUtc { get; init; } = DateTime.UtcNow;
        public string? CorrelationId { get; init; }
        public string? CausationId { get; init; }

        // (tuỳ chọn) tiện ích: thời điểm hết hạn theo OccurredAtUtc + TTL
        public DateTime ExpiresAtUtc => OccurredAtUtc.AddSeconds(TtlSeconds);
    }
}
</file>

<file path="TripService/TripService.Api/Messaging/TripOfferDeclinedConsumer.cs">
using Messaging.Contracts.Routing;
using Messaging.Contracts.Trips;
using Messaging.RabbitMQ.Config;
using Messaging.RabbitMQ.Infrastructure;
using Microsoft.Extensions.Options;
using RabbitMQ.Client;
using RabbitMQ.Client.Events;
using TripService.Application.Abstractions;

namespace TripService.Api.Messaging
{
    public sealed class TripOfferDeclinedConsumer : BaseRabbitConsumer<TripOfferDeclined>
    {
        private readonly IOfferStore _offers;

        public TripOfferDeclinedConsumer(
            ILogger<TripOfferDeclinedConsumer> log,
            IOptions<RabbitMqOptions> opt,
            IOfferStore offers)
            : base(log, opt, Routing.Exchange)
        {
            _offers = offers;
        }

        protected override string RoutingKey => Routing.Keys.TripOfferDeclined;
        protected override string QueueName => "trip.offers.declined";

        protected override async Task HandleAsync(
            TripOfferDeclined message,
            BasicDeliverEventArgs ea,
            IModel channel,
            CancellationToken ct)
        {
            await _offers.MarkDeclinedAsync(message.TripId, message.DriverId, ct);
            Console.WriteLine($"[TripOfferDeclined] Trip={message.TripId} Driver={message.DriverId}");
        }
    }
}
</file>

<file path="TripService/TripService.Api/Messaging/TripOfferedConsumer.cs">
using Driver;
using Messaging.Contracts.Routing;
using Messaging.Contracts.Trips;
using Messaging.RabbitMQ.Abstractions;
using Messaging.RabbitMQ.Config;
using Messaging.RabbitMQ.Infrastructure;
using Microsoft.Extensions.Options;
using RabbitMQ.Client;
using RabbitMQ.Client.Events;
using TripService.Application.Abstractions;
using TripService.Application.Services;
using TripService.Domain.Entities;

namespace TripService.Api.Messaging
{
    public sealed class TripOfferedConsumer : BaseRabbitConsumer<TripOffered>
    {
        private readonly IOfferStore _offers;
        private readonly ITripRepository _repo;
        private readonly TripMatchService _match;
        private readonly IEventPublisher _bus;
        private readonly DriverQuery.DriverQueryClient _driverGrpc;

        public TripOfferedConsumer(
            ILogger<TripOfferedConsumer> log,
            IOptions<RabbitMqOptions> opt,
            IOfferStore offers,
            ITripRepository repo,
            TripMatchService match,
            IEventPublisher bus,
            DriverQuery.DriverQueryClient driverGrpc)
            : base(log, opt, Routing.Exchange)
        {
            _offers = offers;
            _repo = repo;
            _match = match;
            _bus = bus;
            _driverGrpc = driverGrpc;
        }

        protected override string RoutingKey => Routing.Keys.TripOffered;
        protected override string QueueName => "trip.offers.pending";

        protected override async Task HandleAsync(
            TripOffered message,
            BasicDeliverEventArgs ea,
            IModel channel,
            CancellationToken ct)
        {
            // Chờ TTL
            await Task.Delay(TimeSpan.FromSeconds(message.TtlSeconds), ct);

            var declined = await _offers.IsDeclinedAsync(message.TripId, message.DriverId, ct);
            var stillExists = await _offers.ExistsAsync(message.TripId, message.DriverId, ct);

            if (declined)
            {
                var trip = await _repo.GetAsync(message.TripId, ct);
                Console.WriteLine($"[OfferFinalizer] Declined Trip={message.TripId} Driver={message.DriverId}");
                if (trip != null)
                {
                    // (tuỳ) publish notify user: driver từ chối, đang tìm tiếp
                }
                await FindAnotherDriverAsync(message.TripId, ct);
                return;
            }

            if (!stillExists)
            {
                // Offer key không còn (có thể hết TTL do race). Không làm gì thêm.
                return;
            }

            // AUTO-ASSIGN
            var trip2 = await _repo.GetAsync(message.TripId, ct);
            if (trip2 is null) return;

            var resp = await _driverGrpc.MarkTripAssignedAsync(
                new MarkTripAssignedRequest
                {
                    DriverId = message.DriverId.ToString(),
                    TripId = message.TripId.ToString()
                }, cancellationToken: ct);

            if (!resp.Success) return;

            trip2.AssignedDriverId = message.DriverId;
            trip2.Status = TripStatus.Accepted;
            await _repo.UpdateAsync(trip2, ct);

            var assigned = new TripAssigned(
                TripId: trip2.Id,
                DriverId: message.DriverId,
                AssignedAtUtc: DateTime.UtcNow
            );
            await _bus.PublishAsync(Routing.Keys.TripAssigned, assigned, ct);

            // (tuỳ) publish notify user/driver, bật realtime tracking
            Console.WriteLine($"[OfferFinalizer] Assigned Trip={trip2.Id} Driver={message.DriverId}");
        }

        private async Task FindAnotherDriverAsync(Guid tripId, CancellationToken ct)
        {
            var trip = await _repo.GetAsync(tripId, ct);
            if (trip is null) return;

            var next = await _match.FindBestDriverAsync(trip.StartLat, trip.StartLng, radiusKm: 20.0, take: 10);
            if (next is null) return;

            const int ttl = 15;
            await _offers.SetPendingAsync(trip.Id, next.DriverId, TimeSpan.FromSeconds(ttl), ct);

            var offered = new TripOffered(trip.Id, next.DriverId, ttl);
            await _bus.PublishAsync(Routing.Keys.TripOffered, offered, ct);

            Console.WriteLine($"[OfferFinalizer] Re-offer Trip={trip.Id} Driver={next.DriverId}");
        }
    }
}
</file>

<file path="TripService/TripService.Application/Abstractions/IOfferStore.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace TripService.Application.Abstractions
{
    public interface IOfferStore
    {
        Task SetPendingAsync(Guid tripId, Guid driverId, TimeSpan ttl, CancellationToken ct = default);
        Task<bool> ExistsAsync(Guid tripId, Guid driverId, CancellationToken ct = default);
        Task MarkDeclinedAsync(Guid tripId, Guid driverId, CancellationToken ct = default);
        Task<bool> IsDeclinedAsync(Guid tripId, Guid driverId, CancellationToken ct = default);
    }
}
</file>

<file path="TripService/TripService.Application/Offers/RedisOfferStore.cs">
using StackExchange.Redis;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using TripService.Application.Abstractions;

namespace TripService.Application.Offers
{
    public sealed class RedisOfferStore : IOfferStore
    {
        private readonly IDatabase _db;
        public RedisOfferStore(IConnectionMultiplexer mux) => _db = mux.GetDatabase();

        private static string OfferKey(Guid tripId, Guid driverId) => $"offer:trip:{tripId}:driver:{driverId}";
        private static string DeclKey(Guid tripId, Guid driverId) => $"offer:trip:{tripId}:driver:{driverId}:declined";

        public Task SetPendingAsync(Guid tripId, Guid driverId, TimeSpan ttl, CancellationToken ct = default)
            => _db.StringSetAsync(OfferKey(tripId, driverId), "1", ttl);

        public Task<bool> ExistsAsync(Guid tripId, Guid driverId, CancellationToken ct = default)
            => _db.KeyExistsAsync(OfferKey(tripId, driverId));

        public Task MarkDeclinedAsync(Guid tripId, Guid driverId, CancellationToken ct = default)
            => _db.StringSetAsync(DeclKey(tripId, driverId), "1", TimeSpan.FromMinutes(5));

        public async Task<bool> IsDeclinedAsync(Guid tripId, Guid driverId, CancellationToken ct = default)
            => await _db.StringGetAsync(DeclKey(tripId, driverId)) == "1";
    }
}
</file>

<file path=".dockerignore">
**/bin/
**/obj/
**/.git/
**/.vs/
**/node_modules/
**/*.user
**/*.suo
**/*.csproj.user
**/Properties/launchSettings.json
.env
</file>

<file path=".gitignore">
## Ignore Visual Studio temporary files, build results, and
## files generated by popular Visual Studio add-ons.
##
## Get latest from https://github.com/github/gitignore/blob/main/VisualStudio.gitignore

# User-specific files
*.rsuser
*.suo
*.user
*.userosscache
*.sln.docstates
*.env

# User-specific files (MonoDevelop/Xamarin Studio)
*.userprefs

# Mono auto generated files
mono_crash.*

# Build results
[Dd]ebug/
[Dd]ebugPublic/
[Rr]elease/
[Rr]eleases/
x64/
x86/
[Ww][Ii][Nn]32/
[Aa][Rr][Mm]/
[Aa][Rr][Mm]64/
[Aa][Rr][Mm]64[Ee][Cc]/
bld/
[Oo]bj/
[Oo]ut/
[Ll]og/
[Ll]ogs/

# Build results on 'Bin' directories
**/[Bb]in/*
# Uncomment if you have tasks that rely on *.refresh files to move binaries
# (https://github.com/github/gitignore/pull/3736)
#!**/[Bb]in/*.refresh

# Visual Studio 2015/2017 cache/options directory
.vs/
# Uncomment if you have tasks that create the project's static files in wwwroot
#wwwroot/

# Visual Studio 2017 auto generated files
Generated\ Files/

# MSTest test Results
[Tt]est[Rr]esult*/
[Bb]uild[Ll]og.*
*.trx

# NUnit
*.VisualState.xml
TestResult.xml
nunit-*.xml

# Approval Tests result files
*.received.*

# Build Results of an ATL Project
[Dd]ebugPS/
[Rr]eleasePS/
dlldata.c

# Benchmark Results
BenchmarkDotNet.Artifacts/

# .NET Core
project.lock.json
project.fragment.lock.json
artifacts/

# ASP.NET Scaffolding
ScaffoldingReadMe.txt

# StyleCop
StyleCopReport.xml

# Files built by Visual Studio
*_i.c
*_p.c
*_h.h
*.ilk
*.meta
*.obj
*.idb
*.iobj
*.pch
*.pdb
*.ipdb
*.pgc
*.pgd
*.rsp
# but not Directory.Build.rsp, as it configures directory-level build defaults
!Directory.Build.rsp
*.sbr
*.tlb
*.tli
*.tlh
*.tmp
*.tmp_proj
*_wpftmp.csproj
*.log
*.tlog
*.vspscc
*.vssscc
.builds
*.pidb
*.svclog
*.scc

# Chutzpah Test files
_Chutzpah*

# Visual C++ cache files
ipch/
*.aps
*.ncb
*.opendb
*.opensdf
*.sdf
*.cachefile
*.VC.db
*.VC.VC.opendb

# Visual Studio profiler
*.psess
*.vsp
*.vspx
*.sap

# Visual Studio Trace Files
*.e2e

# TFS 2012 Local Workspace
$tf/

# Guidance Automation Toolkit
*.gpState

# ReSharper is a .NET coding add-in
_ReSharper*/
*.[Rr]e[Ss]harper
*.DotSettings.user

# TeamCity is a build add-in
_TeamCity*

# DotCover is a Code Coverage Tool
*.dotCover

# AxoCover is a Code Coverage Tool
.axoCover/*
!.axoCover/settings.json

# Coverlet is a free, cross platform Code Coverage Tool
coverage*.json
coverage*.xml
coverage*.info

# Visual Studio code coverage results
*.coverage
*.coveragexml

# NCrunch
_NCrunch_*
.NCrunch_*
.*crunch*.local.xml
nCrunchTemp_*

# MightyMoose
*.mm.*
AutoTest.Net/

# Web workbench (sass)
.sass-cache/

# Installshield output folder
[Ee]xpress/

# DocProject is a documentation generator add-in
DocProject/buildhelp/
DocProject/Help/*.HxT
DocProject/Help/*.HxC
DocProject/Help/*.hhc
DocProject/Help/*.hhk
DocProject/Help/*.hhp
DocProject/Help/Html2
DocProject/Help/html

# Click-Once directory
publish/

# Publish Web Output
*.[Pp]ublish.xml
*.azurePubxml
# Note: Comment the next line if you want to checkin your web deploy settings,
# but database connection strings (with potential passwords) will be unencrypted
*.pubxml
*.publishproj

# Microsoft Azure Web App publish settings. Comment the next line if you want to
# checkin your Azure Web App publish settings, but sensitive information contained
# in these scripts will be unencrypted
PublishScripts/

# NuGet Packages
*.nupkg
# NuGet Symbol Packages
*.snupkg
# The packages folder can be ignored because of Package Restore
**/[Pp]ackages/*
# except build/, which is used as an MSBuild target.
!**/[Pp]ackages/build/
# Uncomment if necessary however generally it will be regenerated when needed
#!**/[Pp]ackages/repositories.config
# NuGet v3's project.json files produces more ignorable files
*.nuget.props
*.nuget.targets

# Microsoft Azure Build Output
csx/
*.build.csdef

# Microsoft Azure Emulator
ecf/
rcf/

# Windows Store app package directories and files
AppPackages/
BundleArtifacts/
Package.StoreAssociation.xml
_pkginfo.txt
*.appx
*.appxbundle
*.appxupload

# Visual Studio cache files
# files ending in .cache can be ignored
*.[Cc]ache
# but keep track of directories ending in .cache
!?*.[Cc]ache/

# Others
ClientBin/
~$*
*~
*.dbmdl
*.dbproj.schemaview
*.jfm
*.pfx
*.publishsettings
orleans.codegen.cs

# Including strong name files can present a security risk
# (https://github.com/github/gitignore/pull/2483#issue-259490424)
#*.snk

# Since there are multiple workflows, uncomment next line to ignore bower_components
# (https://github.com/github/gitignore/pull/1529#issuecomment-104372622)
#bower_components/

# RIA/Silverlight projects
Generated_Code/

# Backup & report files from converting an old project file
# to a newer Visual Studio version. Backup files are not needed,
# because we have git ;-)
_UpgradeReport_Files/
Backup*/
UpgradeLog*.XML
UpgradeLog*.htm
ServiceFabricBackup/
*.rptproj.bak

# SQL Server files
*.mdf
*.ldf
*.ndf

# Business Intelligence projects
*.rdl.data
*.bim.layout
*.bim_*.settings
*.rptproj.rsuser
*- [Bb]ackup.rdl
*- [Bb]ackup ([0-9]).rdl
*- [Bb]ackup ([0-9][0-9]).rdl

# Microsoft Fakes
FakesAssemblies/

# GhostDoc plugin setting file
*.GhostDoc.xml

# Node.js Tools for Visual Studio
.ntvs_analysis.dat
node_modules/

# Visual Studio 6 build log
*.plg

# Visual Studio 6 workspace options file
*.opt

# Visual Studio 6 auto-generated workspace file (contains which files were open etc.)
*.vbw

# Visual Studio 6 auto-generated project file (contains which files were open etc.)
*.vbp

# Visual Studio 6 workspace and project file (working project files containing files to include in project)
*.dsw
*.dsp

# Visual Studio 6 technical files
*.ncb
*.aps

# Visual Studio LightSwitch build output
**/*.HTMLClient/GeneratedArtifacts
**/*.DesktopClient/GeneratedArtifacts
**/*.DesktopClient/ModelManifest.xml
**/*.Server/GeneratedArtifacts
**/*.Server/ModelManifest.xml
_Pvt_Extensions

# Paket dependency manager
**/.paket/paket.exe
paket-files/

# FAKE - F# Make
**/.fake/

# CodeRush personal settings
**/.cr/personal

# Python Tools for Visual Studio (PTVS)
**/__pycache__/
*.pyc

# Cake - Uncomment if you are using it
#tools/**
#!tools/packages.config

# Tabs Studio
*.tss

# Telerik's JustMock configuration file
*.jmconfig

# BizTalk build output
*.btp.cs
*.btm.cs
*.odx.cs
*.xsd.cs

# OpenCover UI analysis results
OpenCover/

# Azure Stream Analytics local run output
ASALocalRun/

# MSBuild Binary and Structured Log
*.binlog
MSBuild_Logs/

# AWS SAM Build and Temporary Artifacts folder
.aws-sam

# NVidia Nsight GPU debugger configuration file
*.nvuser

# MFractors (Xamarin productivity tool) working folder
**/.mfractor/

# Local History for Visual Studio
**/.localhistory/

# Visual Studio History (VSHistory) files
.vshistory/

# BeatPulse healthcheck temp database
healthchecksdb

# Backup folder for Package Reference Convert tool in Visual Studio 2017
MigrationBackup/

# Ionide (cross platform F# VS Code tools) working folder
**/.ionide/

# Fody - auto-generated XML schema
FodyWeavers.xsd

# VS Code files for those working on multiple tools
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
!.vscode/*.code-snippets

# Local History for Visual Studio Code
.history/

# Built Visual Studio Code Extensions
*.vsix

# Windows Installer files from build outputs
*.cab
*.msi
*.msix
*.msm
*.msp
</file>

<file path="ApiGateway/ApiGateway.sln">
Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.14.36518.9 d17.14
MinimumVisualStudioVersion = 10.0.40219.1
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "ApiGateway", "ApiGateway\ApiGateway.csproj", "{74ABE4CF-DA41-4FAD-AA11-08B36E200C88}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Release|Any CPU = Release|Any CPU
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{74ABE4CF-DA41-4FAD-AA11-08B36E200C88}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{74ABE4CF-DA41-4FAD-AA11-08B36E200C88}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{74ABE4CF-DA41-4FAD-AA11-08B36E200C88}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{74ABE4CF-DA41-4FAD-AA11-08B36E200C88}.Release|Any CPU.Build.0 = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {338C0B0F-7D97-440A-AA9A-7F87E1ACB375}
	EndGlobalSection
EndGlobal
</file>

<file path="ApiGateway/ApiGateway/ApiGateway.csproj">
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Swashbuckle.AspNetCore" Version="6.6.2" />
    <PackageReference Include="Yarp.ReverseProxy" Version="2.3.0" />
  </ItemGroup>

  <ItemGroup>
    <Folder Include="Controllers\" />
  </ItemGroup>

</Project>
</file>

<file path="ApiGateway/ApiGateway/ApiGateway.http">
@ApiGateway_HostAddress = http://localhost:5148

GET {{ApiGateway_HostAddress}}/weatherforecast/
Accept: application/json

###
</file>

<file path="ApiGateway/ApiGateway/appsettings.Development.json">
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
</file>

<file path="ApiGateway/ApiGateway/appsettings.json">
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ReverseProxy": {
    "Routes": {
      "user-route": {
        "ClusterId": "userCluster",
        "Match": { "Path": "/api/users/{**catch-all}" }
      },
      "trip-route": {
        "ClusterId": "tripCluster",
        "Match": { "Path": "/api/trips/{**catch-all}" }
      },
      "driver-route": {
        "ClusterId": "driverCluster",
        "Match": { "Path": "/api/drivers/{**catch-all}" }
      }
    },
    "Clusters": {
      "userCluster": {
        "Destinations": {
          "destination1": { "Address": "http://user-service:8080/" }
        }
      },
      "tripCluster": {
        "Destinations": {
          "destination1": { "Address": "http://trip-service:8080/" }
        }
      },
      "driverCluster": {
        "Destinations": {
          "destination1": { "Address": "http://driver-service:8081/" }
        }
      }
    }
  }

}
</file>

<file path="ApiGateway/ApiGateway/Properties/launchSettings.json">
{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:22818",
      "sslPort": 44369
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "http://localhost:5148",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "https": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "https://localhost:7066;http://localhost:5148",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
</file>

<file path="deploy/docker/ApiGateway.Dockerfile">
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY . .
RUN dotnet restore ./ApiGateway/ApiGateway/ApiGateway.csproj \
 && dotnet publish ./ApiGateway/ApiGateway/ApiGateway.csproj -c Release -o /app/out

FROM mcr.microsoft.com/dotnet/aspnet:8.0
WORKDIR /app
COPY --from=build /app/out .
ENV ASPNETCORE_URLS=http://+:8080
EXPOSE 8080
ENTRYPOINT ["dotnet", "ApiGateway.dll"]
</file>

<file path="deploy/docker/DriverService.Dockerfile">
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY . .
RUN dotnet restore ./DriverService/DriverService.Api/DriverService.Api.csproj \
 && dotnet publish ./DriverService/DriverService.Api/DriverService.Api.csproj -c Release -o /app/out

FROM mcr.microsoft.com/dotnet/aspnet:8.0
WORKDIR /app
COPY --from=build /app/out .
ENV ASPNETCORE_URLS=http://+:8080
EXPOSE 8080
ENTRYPOINT ["dotnet","DriverService.Api.dll"]
</file>

<file path="deploy/docker/TripService.Dockerfile">
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY . .
RUN dotnet restore ./TripService/TripService.Api/TripService.Api.csproj \
 && dotnet publish ./TripService/TripService.Api/TripService.Api.csproj -c Release -o /app/out

FROM mcr.microsoft.com/dotnet/aspnet:8.0
WORKDIR /app
COPY --from=build /app/out .
ENV ASPNETCORE_URLS=http://+:8080
EXPOSE 8080
ENTRYPOINT ["dotnet","TripService.Api.dll"]
</file>

<file path="deploy/docker/UserService.Dockerfile">
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY . .
RUN dotnet restore ./UserService/UserService.Api/UserService.Api.csproj \
 && dotnet publish ./UserService/UserService.Api/UserService.Api.csproj -c Release -o /app/out

FROM mcr.microsoft.com/dotnet/aspnet:8.0
WORKDIR /app
COPY --from=build /app/out .
ENV ASPNETCORE_URLS=http://+:8080
EXPOSE 8080
ENTRYPOINT ["dotnet","UserService.Api.dll"]
</file>

<file path="DriverService/DriverService.Api/appsettings.Development.json">
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
</file>

<file path="DriverService/DriverService.Api/DriverService.Api.http">
@DriverService.Api_HostAddress = http://localhost:5172

GET {{DriverService.Api_HostAddress}}/weatherforecast/
Accept: application/json

###
</file>

<file path="DriverService/DriverService.Api/Messaging/TripAssignedConsumer.cs">
using Messaging.Contracts.Drivers;
using Messaging.Contracts.Routing;
using Messaging.Contracts.Trips;
using Messaging.RabbitMQ.Abstractions;
using Messaging.RabbitMQ.Config;
using Messaging.RabbitMQ.Infrastructure;
using Microsoft.Extensions.Options;
using RabbitMQ.Client;
using RabbitMQ.Client.Events;

namespace DriverService.Api.Messaging
{
    public sealed class TripAssignedConsumer : BaseRabbitConsumer<TripAssigned>
    {
        private readonly IEventPublisher _bus;
        public TripAssignedConsumer(
            ILogger<TripAssignedConsumer> log,
            IOptions<RabbitMqOptions> opt,
            IEventPublisher bus)
            : base(log, opt, Routing.Exchange)
        {
            _bus = bus;
        }

        protected override string RoutingKey => Routing.Keys.TripAssigned;
        protected override string QueueName => "driver.assigned.forwarder";

        protected override async Task HandleAsync(
            TripAssigned message,
            BasicDeliverEventArgs ea,
            IModel channel,
            CancellationToken ct)
        {
            Console.WriteLine($"[TripAssigned] Trip={message.TripId} Driver={message.DriverId}");

            var evt = new DriverAssignedToTrip(
                TripId: message.TripId,
                DriverId: message.DriverId
            );
            await _bus.PublishAsync(Routing.Keys.DriverAssignedToTrip, evt, ct);
        }
    }
}
</file>

<file path="DriverService/DriverService.Api/Messaging/TripCreatedConsumer.cs">
using Messaging.Contracts.Routing;
using Messaging.Contracts.Trips;
using Messaging.RabbitMQ.Config;
using Messaging.RabbitMQ.Infrastructure;
using Microsoft.Extensions.Options;
using RabbitMQ.Client;
using RabbitMQ.Client.Events;

namespace DriverService.Api.Messaging
{
    public sealed class TripCreatedConsumer : BaseRabbitConsumer<TripCreated>
    {
        public TripCreatedConsumer(
            ILogger<TripCreatedConsumer> log,
            IOptions<RabbitMqOptions> opt)
            : base(log, opt, Routing.Exchange) { }

        protected override string RoutingKey => Routing.Keys.TripCreated;
        protected override string QueueName => "driver.tripcreated";

        protected override Task HandleAsync(
            TripCreated message,
            BasicDeliverEventArgs ea,
            IModel channel,
            CancellationToken ct)
        {
            Console.WriteLine($"[TripCreated] Trip={message.TripId} From={message.Start} To={message.End}");
            // Ở phase này chỉ cần biết có chuyến mới, không cần push realtime.
            return Task.CompletedTask;
        }
    }
}
</file>

<file path="DriverService/DriverService.Api/Messaging/TripRequestedConsumer.cs">
using Messaging.Contracts.Routing;
using Messaging.Contracts.Trips;
using Messaging.RabbitMQ.Config;
using Messaging.RabbitMQ.Infrastructure;
using Microsoft.Extensions.Options;
using RabbitMQ.Client;
using RabbitMQ.Client.Events;

namespace DriverService.Api.Messaging
{
    public sealed class TripRequestedConsumer : BaseRabbitConsumer<TripRequested>
    {
        public TripRequestedConsumer(
            ILogger<TripRequestedConsumer> log,
            IOptions<RabbitMqOptions> opt)
            : base(log, opt, Routing.Exchange) { }

        protected override string RoutingKey => Routing.Keys.TripRequested;
        protected override string QueueName => "driver.matching";

        protected override Task HandleAsync(
            TripRequested message,
            BasicDeliverEventArgs ea,
            IModel channel,
            CancellationToken ct)
        {
            Console.WriteLine($"[TripRequested] Trip={message.TripId} Start={message.Start} End={message.End}");
            return Task.CompletedTask;
        }
    }
}
</file>

<file path="DriverService/DriverService.Api/Properties/launchSettings.json">
{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:64687",
      "sslPort": 44342
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "http://localhost:5172",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "https": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "https://localhost:7129;http://localhost:5172",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
</file>

<file path="DriverService/DriverService.Application/Abstractions/IDriverService.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace DriverService.Application.Abstractions
{
    public interface IDriverService
    {
        Task SetOnlineAsync(Guid id, bool online, CancellationToken ct = default);
        Task UpdateLocationAsync(Guid id, double lat, double lng, CancellationToken ct = default);
    }
}
</file>

<file path="DriverService/DriverService.Application/Protos/driver.proto">
syntax = "proto3";

package driver;

service DriverQuery {
  rpc GetDriverInfo (GetDriverInfoRequest) returns (GetDriverInfoResponse);
  rpc MarkTripAssigned (MarkTripAssignedRequest) returns (MarkTripAssignedResponse);
}

message GetDriverInfoRequest {
  string driverId = 1;
}

message GetDriverInfoResponse {
  string driverId = 1;
  string name = 2;
  double lat = 3;
  double lng = 4;
  bool available = 5;
}

message MarkTripAssignedRequest {
  string driverId = 1;
  string tripId = 2;
}

message MarkTripAssignedResponse {
  bool success = 1;
}
</file>

<file path="DriverService/DriverService.Domain/Entities/Driver.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace DriverService.Domain.Domain
{
    public class Driver
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public string FullName { get; set; } = string.Empty;
        public bool Online { get; set; }
        public double Lat { get; set; }
        public double Lng { get; set; }
        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
    }
}
</file>

<file path="DriverService/DriverService.Domain/ValueObjects/GeoPoint.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace DriverService.Domain.ValueObjects
{
    public sealed record GeoPoint
    {
        private double _latitude;
        private double _longitude;

        public double Latitude
        {
            get => _latitude;
            init
            {
                if (value < -90 || value > 90)
                    throw new ArgumentOutOfRangeException(nameof(Latitude), "Latitude must be between -90 and 90 degrees.");
                _latitude = value;
            }
        }

        public double Longitude
        {
            get => _longitude;
            init
            {
                if (value < -180 || value > 180)
                    throw new ArgumentOutOfRangeException(nameof(Longitude), "Longitude must be between -180 and 180 degrees.");
                _longitude = value;
            }
        }

        public GeoPoint(double latitude, double longitude)
        {
            Latitude = latitude;
            Longitude = longitude;
        }
    }
}
</file>

<file path="DriverService/DriverService.Infrastructure/Migrations/20251101135748_Initial Create.cs">
using System;
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace DriverService.Infrastructure.Migrations
{
    /// <inheritdoc />
    public partial class InitialCreate : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.CreateTable(
                name: "Drivers",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    FullName = table.Column<string>(type: "character varying(150)", maxLength: 150, nullable: false),
                    Online = table.Column<bool>(type: "boolean", nullable: false),
                    Lat = table.Column<double>(type: "double precision", nullable: false),
                    Lng = table.Column<double>(type: "double precision", nullable: false),
                    UpdatedAt = table.Column<DateTime>(type: "timestamp with time zone", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_Drivers", x => x.Id);
                });
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropTable(
                name: "Drivers");
        }
    }
}
</file>

<file path="DriverService/DriverService.Infrastructure/Migrations/20251101135748_Initial Create.Designer.cs">
// <auto-generated />
using System;
using DriverService.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace DriverService.Infrastructure.Migrations
{
    [DbContext(typeof(DriverDbContext))]
    [Migration("20251101135748_Initial Create")]
    partial class InitialCreate
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "8.0.21")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("DriverService.Domain.Domain.Driver", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("FullName")
                        .IsRequired()
                        .HasMaxLength(150)
                        .HasColumnType("character varying(150)");

                    b.Property<double>("Lat")
                        .HasColumnType("double precision");

                    b.Property<double>("Lng")
                        .HasColumnType("double precision");

                    b.Property<bool>("Online")
                        .HasColumnType("boolean");

                    b.Property<DateTime>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.ToTable("Drivers");
                });
#pragma warning restore 612, 618
        }
    }
}
</file>

<file path="DriverService/DriverService.Infrastructure/Migrations/DriverDbContextModelSnapshot.cs">
// <auto-generated />
using System;
using DriverService.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace DriverService.Infrastructure.Migrations
{
    [DbContext(typeof(DriverDbContext))]
    partial class DriverDbContextModelSnapshot : ModelSnapshot
    {
        protected override void BuildModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "8.0.21")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("DriverService.Domain.Domain.Driver", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("FullName")
                        .IsRequired()
                        .HasMaxLength(150)
                        .HasColumnType("character varying(150)");

                    b.Property<double>("Lat")
                        .HasColumnType("double precision");

                    b.Property<double>("Lng")
                        .HasColumnType("double precision");

                    b.Property<bool>("Online")
                        .HasColumnType("boolean");

                    b.Property<DateTime>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.ToTable("Drivers");
                });
#pragma warning restore 612, 618
        }
    }
}
</file>

<file path="Message/Message.sln">
Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.14.36518.9
MinimumVisualStudioVersion = 10.0.40219.1
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Messaging.Contracts", "Messaging.Contracts\Messaging.Contracts.csproj", "{FCB268D5-21C7-4128-BD4A-70B66497A583}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Messaging.RabbitMQ", "Messaging.RabbitMQ\Messaging.RabbitMQ.csproj", "{F2A7CB90-9419-4A5F-9C63-1751216439D9}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Release|Any CPU = Release|Any CPU
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{FCB268D5-21C7-4128-BD4A-70B66497A583}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{FCB268D5-21C7-4128-BD4A-70B66497A583}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{FCB268D5-21C7-4128-BD4A-70B66497A583}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{FCB268D5-21C7-4128-BD4A-70B66497A583}.Release|Any CPU.Build.0 = Release|Any CPU
		{F2A7CB90-9419-4A5F-9C63-1751216439D9}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{F2A7CB90-9419-4A5F-9C63-1751216439D9}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{F2A7CB90-9419-4A5F-9C63-1751216439D9}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{F2A7CB90-9419-4A5F-9C63-1751216439D9}.Release|Any CPU.Build.0 = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {B6C6CA50-F552-4802-B9DE-365085FF9C6E}
	EndGlobalSection
EndGlobal
</file>

<file path="Message/Messaging.Contracts/Abstractions/IIntergrationCommand.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.Contracts.Abstractions
{
    /// Marker for commands (intent to perform, typically request/response). Define it here but may use gRPC instead
    public interface IIntegrationCommand : IIntegrationMessage { }
}
</file>

<file path="Message/Messaging.Contracts/Abstractions/IIntergrationEvent.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.Contracts.Abstractions
{
    /// Marker for domain/integration events (past-tense, fan-out via broker).
    public interface IIntegrationEvent : IIntegrationMessage { }
}
</file>

<file path="Message/Messaging.Contracts/Abstractions/IIntergrationMessage.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.Contracts.Abstractions
{
    public interface IIntegrationMessage
    {
        Guid MessageId { get; init; }         // unique per publish
        DateTime OccurredAtUtc { get; init; } // creation/publish time (UTC)
        string? CorrelationId { get; init; }  // trace same request across services
        string? CausationId { get; init; }    // which message/request caused this
    }
}
</file>

<file path="Message/Messaging.Contracts/Common/GeoPoint.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.Contracts.Common
{
    public readonly record struct GeoPoint(double Lat, double Lng)
    {
        public override string ToString() => $"({Lat},{Lng})";
    }
}
</file>

<file path="Message/Messaging.Contracts/Drivers/DriverAssignedToTrip.cs">
using Messaging.Contracts.Abstractions;

namespace Messaging.Contracts.Drivers
{
    public sealed record DriverAssignedToTrip(
        Guid TripId,
        Guid DriverId
    ) : IIntegrationEvent
    {
        public Guid MessageId { get; init; } = Guid.NewGuid();
        public DateTime OccurredAtUtc { get; init; } = DateTime.UtcNow;
        public string? CorrelationId { get; init; }
        public string? CausationId { get; init; }
    }
}
</file>

<file path="Message/Messaging.Contracts/Drivers/DriverLocationUpdated.cs">
using Messaging.Contracts.Abstractions;
using Messaging.Contracts.Common;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.Contracts.Drivers
{
    public sealed record DriverLocationUpdated(
    Guid DriverId,
    GeoPoint Location,
    DateTime UpdatedAtUtc
) : IIntegrationEvent
    {
        public Guid MessageId { get; init; } = Guid.NewGuid();
        public DateTime OccurredAtUtc { get; init; } = DateTime.UtcNow;
        public string? CorrelationId { get; init; }
        public string? CausationId { get; init; }
    }
}
</file>

<file path="Message/Messaging.Contracts/Drivers/DriverStatusChanged.cs">
using Messaging.Contracts.Abstractions;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.Contracts.Drivers
{
    public sealed record DriverStatusChanged(
    Guid DriverId,
    bool Online
) : IIntegrationEvent
    {
        public Guid MessageId { get; init; } = Guid.NewGuid();
        public DateTime OccurredAtUtc { get; init; } = DateTime.UtcNow;
        public string? CorrelationId { get; init; }
        public string? CausationId { get; init; }
    }
}
</file>

<file path="Message/Messaging.Contracts/Messaging.Contracts.csproj">
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

</Project>
</file>

<file path="Message/Messaging.Contracts/Trips/TripAccepted.cs">
using Messaging.Contracts.Abstractions;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.Contracts.Trips
{
    public sealed record TripAccepted(
    Guid TripId,
    Guid DriverId,
    DateTime AcceptedAtUtc
) : IIntegrationEvent
    {
        public Guid MessageId { get; init; } = Guid.NewGuid();
        public DateTime OccurredAtUtc { get; init; } = DateTime.UtcNow;
        public string? CorrelationId { get; init; }
        public string? CausationId { get; init; }
    }
}
</file>

<file path="Message/Messaging.Contracts/Trips/TripAssigned.cs">
using Messaging.Contracts.Abstractions;

namespace Messaging.Contracts.Trips
{
    public sealed record TripAssigned(
        Guid TripId,
        Guid DriverId,
        DateTime AssignedAtUtc
    ) : IIntegrationEvent
    {
        public Guid MessageId { get; init; } = Guid.NewGuid();
        public DateTime OccurredAtUtc { get; init; } = DateTime.UtcNow;
        public string? CorrelationId { get; init; }
        public string? CausationId { get; init; }
    }
}
</file>

<file path="Message/Messaging.Contracts/Trips/TripCanceled.cs">
using Messaging.Contracts.Abstractions;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.Contracts.Trips
{
    public sealed record TripCanceled(
    Guid TripId,
    string Reason    
) : IIntegrationEvent
    {
        public Guid MessageId { get; init; } = Guid.NewGuid();
        public DateTime OccurredAtUtc { get; init; } = DateTime.UtcNow;
        public string? CorrelationId { get; init; }
        public string? CausationId { get; init; }
    }
}
</file>

<file path="Message/Messaging.Contracts/Trips/TripCreated.cs">
using Messaging.Contracts.Abstractions;
using Messaging.Contracts.Common;

namespace Messaging.Contracts.Trips
{
    public sealed record TripCreated(
        Guid TripId,
        Guid PassengerId,
        GeoPoint Start,
        GeoPoint End,
        DateTime CreatedAtUtc
    ) : IIntegrationEvent
    {
        public Guid MessageId { get; init; } = Guid.NewGuid();
        public DateTime OccurredAtUtc { get; init; } = DateTime.UtcNow;
        public string? CorrelationId { get; init; }
        public string? CausationId { get; init; }
    }
}
</file>

<file path="Message/Messaging.Contracts/Trips/TripRequested.cs">
using Messaging.Contracts.Abstractions;
using Messaging.Contracts.Common;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.Contracts.Trips
{
    public sealed record TripRequested(
    Guid TripId,
    Guid RiderId,
    GeoPoint Start,
    GeoPoint End
) : IIntegrationEvent
    {
        public Guid MessageId { get; init; } = Guid.NewGuid();
        public DateTime OccurredAtUtc { get; init; } = DateTime.UtcNow;
        public string? CorrelationId { get; init; }
        public string? CausationId { get; init; }
    }
}
</file>

<file path="Message/Messaging.RabbitMQ/Abstractions/IEventPublisher.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.RabbitMQ.Abstractions
{
    public interface IEventPublisher
    {
        Task PublishAsync<T>(string routingKey, T payload, CancellationToken ct = default);
    }
}
</file>

<file path="Message/Messaging.RabbitMQ/Abstractions/IRabbitConsumer.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.RabbitMQ.Abstractions
{
    public interface IRabbitConsumer { }
}
</file>

<file path="Message/Messaging.RabbitMQ/Config/RabbitMqOptions.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.RabbitMQ.Config
{
    public sealed class RabbitMqOptions
    {
        public string HostName { get; set; } = "rabbitmq";
        public int Port { get; set; } = 5672;
        public string UserName { get; set; } = "guest";
        public string Password { get; set; } = "guest";
        public string VirtualHost { get; set; } = "/";
        public ushort PrefetchCount { get; set; } = 50; 
        public string ClientName { get; set; } = "uitgo-app"; 
    }
}
</file>

<file path="Message/Messaging.RabbitMQ/Infrastructure/BaseRabbitConsumer.cs">
using Messaging.RabbitMQ.Abstractions;
using Messaging.RabbitMQ.Config;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;
using RabbitMQ.Client;
using RabbitMQ.Client.Events;
using System.Text;
using System.Text.Json;

namespace Messaging.RabbitMQ.Infrastructure
{
    public abstract class BaseRabbitConsumer<T> : BackgroundService, IRabbitConsumer
    {
        private readonly ILogger _log;
        private readonly RabbitMqOptions _opt;
        private readonly string _exchangeName;
        private IConnection? _conn;
        private IModel? _ch;
        private string? _queueName;

        protected BaseRabbitConsumer(
            ILogger logger,
            IOptions<RabbitMqOptions> opt,
            string exchangeName)
        {
            _log = logger;
            _opt = opt.Value;
            _exchangeName = exchangeName;
        }

        protected abstract string RoutingKey { get; }
        protected abstract string QueueName { get; }
        protected abstract Task HandleAsync(T message, BasicDeliverEventArgs ea, IModel channel, CancellationToken ct);

        protected override Task ExecuteAsync(CancellationToken stoppingToken)
        {
            var factory = new ConnectionFactory
            {
                HostName = _opt.HostName,
                Port = _opt.Port,
                UserName = _opt.UserName,
                Password = _opt.Password,
                VirtualHost = _opt.VirtualHost,
                ClientProvidedName = $"{_opt.ClientName}-{QueueName}-consumer",
                DispatchConsumersAsync = true
            };

            _conn = factory.CreateConnection();
            _ch = _conn.CreateModel();
            _ch.ExchangeDeclare(_exchangeName, ExchangeType.Topic, durable: true);

            var q = _ch.QueueDeclare(queue: QueueName, durable: true, exclusive: false, autoDelete: false);
            _queueName = q.QueueName;

            _ch.QueueBind(_queueName, _exchangeName, RoutingKey);
            _ch.BasicQos(0, _opt.PrefetchCount, false);

            var consumer = new AsyncEventingBasicConsumer(_ch);
            consumer.Received += async (_, ea) =>
            {
                try
                {
                    var json = Encoding.UTF8.GetString(ea.Body.Span);
                    var msg = JsonSerializer.Deserialize<T>(json, JsonSerializerSettings.Default)!;

                    await HandleAsync(msg, ea, _ch!, stoppingToken);
                    _ch!.BasicAck(ea.DeliveryTag, multiple: false);
                }
                catch (Exception ex)
                {
                    _log.LogError(ex, "[RabbitMQ] Error handling {RoutingKey}", RoutingKey);
                    _ch!.BasicNack(ea.DeliveryTag, multiple: false, requeue: false);
                }
            };

            _ch.BasicConsume(_queueName, autoAck: false, consumer);
            return Task.CompletedTask;
        }

        public override void Dispose()
        {
            _ch?.Dispose();
            _conn?.Dispose();
            base.Dispose();
        }
    }
}
</file>

<file path="Message/Messaging.RabbitMQ/Infrastructure/JsonSerializerSettings.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Threading.Tasks;

namespace Messaging.RabbitMQ.Infrastructure
{
    internal static class JsonSerializerSettings
    {
        public static readonly JsonSerializerOptions Default = new()
        {
            PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
            DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull,
            WriteIndented = false
        };
    }
}
</file>

<file path="Message/Messaging.RabbitMQ/Messaging.RabbitMQ.csproj">
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Extensions.Hosting.Abstractions" Version="8.0.1" />
    <PackageReference Include="Microsoft.Extensions.Options.ConfigurationExtensions" Version="8.0.0" />
    <PackageReference Include="RabbitMQ.Client" Version="6.8.1" />
  </ItemGroup>

</Project>
</file>

<file path="Message/Messaging.RabbitMQ/ServiceCollectionExtensions.cs">
using Messaging.RabbitMQ.Abstractions;
using Messaging.RabbitMQ.Config;
using Messaging.RabbitMQ.Infrastructure;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Options;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.RabbitMQ
{
    public static class ServiceCollectionExtensions
    {
        public static IServiceCollection AddRabbitMqEventBus(
            this IServiceCollection services,
            IConfiguration cfg,
            string exchangeName)
        {
            services.Configure<RabbitMqOptions>(cfg.GetSection("RabbitMQ"));

            // Publisher
            services.AddSingleton<IEventPublisher>(sp =>
            {
                var opt = sp.GetRequiredService<IOptions<RabbitMqOptions>>();
                return new RabbitMqPublisher(opt, exchangeName);
            });

            return services;
        }
    }
}
</file>

<file path="nginx_gateway/nginx.conf">
# worker_processes auto;
# events { worker_connections 1024; }

# http {
#   sendfile on;
#   client_max_body_size 20m;

#   upstream user_svc   { server user-service:8080; }
#   upstream trip_svc   { server trip-service:8080; }
#   upstream driver_svc { server driver-service:8080; }

#   server {
#     listen 80;

#     location /api/auth/     { proxy_pass http://user_svc/; }
#     location /api/users/    { proxy_pass http://user_svc/; }
#     location /api/trips/    { proxy_pass http://trip_svc/; }
#     location /api/drivers/  { proxy_pass http://driver_svc/; }

#     location /health { return 200 "ok"; }
#   }
# }
</file>

<file path="nginx_gateway/Nginx.Dockerfile">
FROM nginx:alpine

RUN rm /etc/nginx/conf.d/default.conf

COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
</file>

<file path="README.md">
# uit-go
</file>

<file path="Shared/Shared.sln">
Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.14.36518.9 d17.14
MinimumVisualStudioVersion = 10.0.40219.1
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Shared", "Shared\Shared.csproj", "{94E6C954-0393-419A-B3CD-4BC9A4BAB69C}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Release|Any CPU = Release|Any CPU
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{94E6C954-0393-419A-B3CD-4BC9A4BAB69C}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{94E6C954-0393-419A-B3CD-4BC9A4BAB69C}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{94E6C954-0393-419A-B3CD-4BC9A4BAB69C}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{94E6C954-0393-419A-B3CD-4BC9A4BAB69C}.Release|Any CPU.Build.0 = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {B709F582-BF9E-4193-99E9-82A018A4BE93}
	EndGlobalSection
EndGlobal
</file>

<file path="Shared/Shared/GeoUtils.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Shared
{
    public static class GeoUtils
    {
        private const double CellKm = 0.5;
        public static (int x, int y) Cell(double lat, double lng)
            => ((int)Math.Floor(lat / CellKm), (int)Math.Floor(lng / CellKm));

        public static IEnumerable<(int, int)> NeighborCells((int x, int y) c, double radiusKm)
        {
            int d = (int)Math.Ceiling(radiusKm / CellKm);
            for (int i = -d; i <= d; i++)
                for (int j = -d; j <= d; j++)
                    yield return (c.x + i, c.y + j);
        }
    }

}
</file>

<file path="Shared/Shared/Shared.csproj">
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Google.Protobuf" Version="3.33.0" />
    <PackageReference Include="Grpc.Core" Version="2.46.6" />
    <PackageReference Include="Grpc.Net.Client" Version="2.71.0" />
    <PackageReference Include="Grpc.Net.ClientFactory" Version="2.71.0" />
    <PackageReference Include="Grpc.Tools" Version="2.46.6">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
  </ItemGroup>

</Project>
</file>

<file path="TripService/TripService.Api/appsettings.Development.json">
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
</file>

<file path="TripService/TripService.Api/Properties/launchSettings.json">
{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:25467",
      "sslPort": 44383
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "http://localhost:5047",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "https": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "https://localhost:7010;http://localhost:5047",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
</file>

<file path="TripService/TripService.Api/TripService.Api.http">
@TripService.Api_HostAddress = http://localhost:5047

GET {{TripService.Api_HostAddress}}/weatherforecast/
Accept: application/json

###
</file>

<file path="TripService/TripService.Application/Abstractions/ITripRepository.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using TripService.Domain.Entities;

namespace TripService.Application.Abstractions
{
    public interface ITripRepository
    {
        Task<Trip?> GetAsync(Guid id, CancellationToken ct = default);
        Task AddAsync(Trip trip, CancellationToken ct = default);
        Task UpdateAsync(Trip trip, CancellationToken ct = default);
    }
}
</file>

<file path="TripService/TripService.Application/Abstractions/ITripService.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using TripService.Domain.Entities;

namespace TripService.Application.Abstractions
{
    public interface ITripService
    {
        Task<Trip> CreateAsync(Trip trip, CancellationToken ct = default);
        Task<Trip?> GetAsync(Guid id, CancellationToken ct = default);
        Task CancelAsync(Guid id, CancellationToken ct = default);
    }
}
</file>

<file path="TripService/TripService.Application/Protos/driver.proto">
syntax = "proto3";

package driver;

service DriverQuery {
  rpc GetDriverInfo (GetDriverInfoRequest) returns (GetDriverInfoResponse);
  rpc MarkTripAssigned (MarkTripAssignedRequest) returns (MarkTripAssignedResponse);
}

message GetDriverInfoRequest {
  string driverId = 1;
}

message GetDriverInfoResponse {
  string driverId = 1;
  string name = 2;
  double lat = 3;
  double lng = 4;
  bool available = 5;
}

message MarkTripAssignedRequest {
  string driverId = 1;
  string tripId = 2;
}

message MarkTripAssignedResponse {
  bool success = 1;
}
</file>

<file path="TripService/TripService.Application/Services/TripMatchService.cs">
using Driver;
using StackExchange.Redis;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace TripService.Application.Services
{
    public class TripMatchService
    {
        private readonly IConnectionMultiplexer _redis;
        private readonly DriverQuery.DriverQueryClient _driverGrpc;

        public TripMatchService(
            IConnectionMultiplexer redis,
            DriverQuery.DriverQueryClient driverGrpc)
        {
            _redis = redis;
            _driverGrpc = driverGrpc;
        }

        public async Task<DriverCandidate?> FindBestDriverAsync(
            double lat, double lng,
            double radiusKm,
            int take)
        {
            var db = _redis.GetDatabase();

            var results = await db.GeoRadiusAsync(
                "drivers:online",
                longitude: lng,
                latitude: lat,
                radius: radiusKm,
                unit: GeoUnit.Kilometers,
                count: take,
                order: Order.Ascending);

            foreach (var r in results)
            {
                var driverId = r.Member.ToString();

                // confirm với DriverService qua gRPC
                var info = await _driverGrpc.GetDriverInfoAsync(
                    new GetDriverInfoRequest
                    {
                        DriverId = driverId
                    }
                );

                if (!info.Available)
                    continue;

                return new DriverCandidate
                {
                    DriverId = Guid.Parse(driverId),
                    DistanceKm = r.Distance ?? 0
                };
            }

            return null;
        }

        public async Task<bool> TryLockTripAsync(Guid tripId, TimeSpan ttl)
        {
            var db = _redis.GetDatabase();
            return await db.StringSetAsync(
                $"trip:{tripId}:lock",
                "1",
                ttl,
                When.NotExists
            );
        }

        public async Task<bool> MarkDriverAssignedAsync(string driverId, Guid tripId)
        {
            var resp = await _driverGrpc.MarkTripAssignedAsync(new MarkTripAssignedRequest
            {
                DriverId = driverId,
                TripId = tripId.ToString()
            });

            return resp.Success;
        }
    }

    public class DriverCandidate
    {
        public Guid DriverId { get; set; }
        public double DistanceKm { get; set; }
    }

}
</file>

<file path="TripService/TripService.Infrastructure/Migrations/20251101134456_Initial Create.cs">
using System;
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace TripService.Infrastructure.Migrations
{
    /// <inheritdoc />
    public partial class InitialCreate : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.CreateTable(
                name: "Trips",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    RiderId = table.Column<Guid>(type: "uuid", nullable: false),
                    DriverId = table.Column<Guid>(type: "uuid", nullable: true),
                    StartLat = table.Column<double>(type: "double precision", nullable: false),
                    StartLng = table.Column<double>(type: "double precision", nullable: false),
                    EndLat = table.Column<double>(type: "double precision", nullable: false),
                    EndLng = table.Column<double>(type: "double precision", nullable: false),
                    Status = table.Column<string>(type: "text", nullable: false),
                    CreatedAt = table.Column<DateTime>(type: "timestamp with time zone", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_Trips", x => x.Id);
                });
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropTable(
                name: "Trips");
        }
    }
}
</file>

<file path="TripService/TripService.Infrastructure/Migrations/20251101134456_Initial Create.Designer.cs">
// <auto-generated />
using System;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;
using TripService.Infrastructure.Data;

#nullable disable

namespace TripService.Infrastructure.Migrations
{
    [DbContext(typeof(TripDbContext))]
    [Migration("20251101134456_Initial Create")]
    partial class InitialCreate
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "8.0.21")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("TripService.Domain.Entities.Trip", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("DriverId")
                        .HasColumnType("uuid");

                    b.Property<double>("EndLat")
                        .HasColumnType("double precision");

                    b.Property<double>("EndLng")
                        .HasColumnType("double precision");

                    b.Property<Guid>("RiderId")
                        .HasColumnType("uuid");

                    b.Property<double>("StartLat")
                        .HasColumnType("double precision");

                    b.Property<double>("StartLng")
                        .HasColumnType("double precision");

                    b.Property<string>("Status")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Trips");
                });
#pragma warning restore 612, 618
        }
    }
}
</file>

<file path="TripService/TripService.Infrastructure/Migrations/20251102140556_change trip attributes.cs">
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace TripService.Infrastructure.Migrations
{
    /// <inheritdoc />
    public partial class changetripattributes : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.RenameColumn(
                name: "RiderId",
                table: "Trips",
                newName: "PassengerId");

            migrationBuilder.RenameColumn(
                name: "DriverId",
                table: "Trips",
                newName: "AssignedDriverId");
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.RenameColumn(
                name: "PassengerId",
                table: "Trips",
                newName: "RiderId");

            migrationBuilder.RenameColumn(
                name: "AssignedDriverId",
                table: "Trips",
                newName: "DriverId");
        }
    }
}
</file>

<file path="TripService/TripService.Infrastructure/Migrations/20251102140556_change trip attributes.Designer.cs">
// <auto-generated />
using System;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;
using TripService.Infrastructure.Data;

#nullable disable

namespace TripService.Infrastructure.Migrations
{
    [DbContext(typeof(TripDbContext))]
    [Migration("20251102140556_change trip attributes")]
    partial class changetripattributes
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "8.0.21")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("TripService.Domain.Entities.Trip", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<Guid?>("AssignedDriverId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<double>("EndLat")
                        .HasColumnType("double precision");

                    b.Property<double>("EndLng")
                        .HasColumnType("double precision");

                    b.Property<Guid>("PassengerId")
                        .HasColumnType("uuid");

                    b.Property<double>("StartLat")
                        .HasColumnType("double precision");

                    b.Property<double>("StartLng")
                        .HasColumnType("double precision");

                    b.Property<string>("Status")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Trips");
                });
#pragma warning restore 612, 618
        }
    }
}
</file>

<file path="TripService/TripService.Infrastructure/Repositories/EfTripRepository.cs">
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using TripService.Application.Abstractions;
using TripService.Domain.Entities;
using TripService.Infrastructure.Data;

namespace TripService.Infrastructure.Repositories
{
    public sealed class EfTripRepository : ITripRepository
    {
        private readonly TripDbContext _db;

        public EfTripRepository(TripDbContext db) => _db = db;

        public async Task<Trip?> GetAsync(Guid id, CancellationToken ct = default)
        {
            return await _db.Trips
                .AsNoTracking()
                .FirstOrDefaultAsync(x => x.Id == id, ct);
        }

        public async Task AddAsync(Trip trip, CancellationToken ct = default)
        {
            _db.Trips.Add(trip);
            await _db.SaveChangesAsync(ct);
        }

        public async Task UpdateAsync(Trip trip, CancellationToken ct = default)
        {
            _db.Trips.Update(trip);
            await _db.SaveChangesAsync(ct);
        }
    }
}
</file>

<file path="UserService/UserService.Api/appsettings.Development.json">
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
</file>

<file path="UserService/UserService.Api/Properties/launchSettings.json">
{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:9651",
      "sslPort": 44348
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "http://localhost:5208",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "https": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "https://localhost:7029;http://localhost:5208",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
</file>

<file path="UserService/UserService.Api/UserService.Api.csproj">
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.21">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.21">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="8.0.11" />
    <PackageReference Include="Swashbuckle.AspNetCore" Version="6.6.2" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\UserService.Application\UserService.Application.csproj" />
    <ProjectReference Include="..\UserService.Domain\UserService.Domain.csproj" />
    <ProjectReference Include="..\UserService.Infrastructure\UserService.Infrastructure.csproj" />
  </ItemGroup>

</Project>
</file>

<file path="UserService/UserService.Api/UserService.Api.http">
@UserService.Api_HostAddress = http://localhost:5208

GET {{UserService.Api_HostAddress}}/weatherforecast/
Accept: application/json

###
</file>

<file path="UserService/UserService.Application/Abstractions/IAuthService.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using UserService.Domain.Entities;

namespace UserService.Application.Abstractions
{
    public interface IAuthService
    {
        Task<User> RegisterAsync(string email, string password, string fullName, CancellationToken ct = default);
        Task<string> LoginAsync(string email, string password, CancellationToken ct = default);
    }
}
</file>

<file path="UserService/UserService.Application/Abstractions/IJwtTokenProvider.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace UserService.Application.Abstractions
{
    public interface IJwtTokenProvider
    {
        string CreateToken(string userId, string email);
    }
}
</file>

<file path="UserService/UserService.Application/Abstractions/IUserRepository.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using UserService.Domain.Entities;

namespace UserService.Application.Abstractions
{
    public interface IUserRepository
    {
        Task<User?> GetByEmailAsync(string email, CancellationToken ct = default);
        Task AddAsync(User user, CancellationToken ct = default);
    }
}
</file>

<file path="UserService/UserService.Application/Dtos/LoginDto.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace UserService.Application.Dtos
{
    public record LoginDto(string Email, string Password);
}
</file>

<file path="UserService/UserService.Application/Dtos/RegisterDto.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace UserService.Application.Dtos
{
    public record RegisterDto(string Email, string Password, string FullName);
}
</file>

<file path="UserService/UserService.Application/Services/AuthService.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using UserService.Application.Abstractions;
using UserService.Domain.Entities;

namespace UserService.Application.Services
{
    public class AuthService : IAuthService
    {
        private readonly IUserRepository _repo;
        private readonly IJwtTokenProvider _jwt;

        public AuthService(IUserRepository repo, IJwtTokenProvider jwt)
        {
            _repo = repo;
            _jwt = jwt;
        }

        public async Task<User> RegisterAsync(string email, string password, string fullName, CancellationToken ct = default)
        {
            if (await _repo.GetByEmailAsync(email, ct) is not null)
                throw new InvalidOperationException("Email already registered");

            var hash = BCrypt.Net.BCrypt.HashPassword(password);
            var user = new User { Email = email, PasswordHash = hash, FullName = fullName };
            await _repo.AddAsync(user, ct);
            return user;
        }

        public async Task<string> LoginAsync(string email, string password, CancellationToken ct = default)
        {
            var user = await _repo.GetByEmailAsync(email, ct) ?? throw new UnauthorizedAccessException("Invalid credentials");
            if (!BCrypt.Net.BCrypt.Verify(password, user.PasswordHash))
                throw new UnauthorizedAccessException("Invalid credentials");

            return _jwt.CreateToken(user.Id.ToString(), user.Email);
        }
    }
}
</file>

<file path="UserService/UserService.Application/UserService.Application.csproj">
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="BCrypt.Net-Next" Version="4.0.3" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\UserService.Domain\UserService.Domain.csproj" />
  </ItemGroup>

</Project>
</file>

<file path="UserService/UserService.Domain/Entities/User.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace UserService.Domain.Entities
{
    public class User
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public string Username { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string PasswordHash { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    }
}
</file>

<file path="UserService/UserService.Domain/UserService.Domain.csproj">
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

</Project>
</file>

<file path="UserService/UserService.Infrastructure/Auth/JwtSettings.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace UserService.Infrastructure.Auth
{
    public class JwtSettings
    {
        public string Secret { get; set; } = string.Empty;
        public string Issuer { get; set; } = string.Empty;
        public string Audience { get; set; } = string.Empty;
        public int ExpiryMinutes { get; set; }
    }
}
</file>

<file path="UserService/UserService.Infrastructure/Auth/JwtTokenProvider.cs">
using Microsoft.Extensions.Options;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;
using UserService.Application.Abstractions;

namespace UserService.Infrastructure.Auth
{
    public class JwtTokenProvider : IJwtTokenProvider
    {
        private readonly string _secret;
        public JwtTokenProvider(IOptions<JwtSettings> options) => _secret = options.Value.Secret ?? throw new("Missing Jwt:Secret");

        public string CreateToken(string userId, string email)
        {
            var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_secret));
            var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);
            var claims = new[] { new Claim("sub", userId), new Claim("email", email) };
            var token = new JwtSecurityToken(claims: claims, expires: DateTime.UtcNow.AddDays(1), signingCredentials: creds);
            return new JwtSecurityTokenHandler().WriteToken(token);
        }
    }
}
</file>

<file path="UserService/UserService.Infrastructure/Data/UserDbContext.cs">
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection.Emit;
using System.Text;
using System.Threading.Tasks;
using UserService.Domain.Entities;

namespace UserService.Infrastructure.Data
{
    public class UserDbContext : DbContext
    {
        public UserDbContext(DbContextOptions<UserDbContext> opt) : base(opt) { }
        public DbSet<User> Users { get; set; }

        protected override void OnModelCreating(ModelBuilder b)
        {
            b.Entity<User>(e =>
            {
                e.HasIndex(x => x.Email).IsUnique();
                e.Property(x => x.Username).HasMaxLength(320).IsRequired();
                e.Property(x => x.PasswordHash).IsRequired();
                e.Property(x => x.FullName).HasMaxLength(150);
            });
        }
    }
}
</file>

<file path="UserService/UserService.Infrastructure/Migrations/20251101140406_Initial Create.cs">
using System;
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace UserService.Infrastructure.Migrations
{
    /// <inheritdoc />
    public partial class InitialCreate : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.CreateTable(
                name: "Users",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    Username = table.Column<string>(type: "character varying(320)", maxLength: 320, nullable: false),
                    FullName = table.Column<string>(type: "character varying(150)", maxLength: 150, nullable: false),
                    Email = table.Column<string>(type: "text", nullable: false),
                    PasswordHash = table.Column<string>(type: "text", nullable: false),
                    CreatedAt = table.Column<DateTime>(type: "timestamp with time zone", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_Users", x => x.Id);
                });

            migrationBuilder.CreateIndex(
                name: "IX_Users_Email",
                table: "Users",
                column: "Email",
                unique: true);
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropTable(
                name: "Users");
        }
    }
}
</file>

<file path="UserService/UserService.Infrastructure/Migrations/20251101140406_Initial Create.Designer.cs">
// <auto-generated />
using System;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;
using UserService.Infrastructure.Data;

#nullable disable

namespace UserService.Infrastructure.Migrations
{
    [DbContext(typeof(UserDbContext))]
    [Migration("20251101140406_Initial Create")]
    partial class InitialCreate
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "8.0.21")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("UserService.Domain.Entities.User", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Email")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("FullName")
                        .IsRequired()
                        .HasMaxLength(150)
                        .HasColumnType("character varying(150)");

                    b.Property<string>("PasswordHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("Username")
                        .IsRequired()
                        .HasMaxLength(320)
                        .HasColumnType("character varying(320)");

                    b.HasKey("Id");

                    b.HasIndex("Email")
                        .IsUnique();

                    b.ToTable("Users");
                });
#pragma warning restore 612, 618
        }
    }
}
</file>

<file path="UserService/UserService.Infrastructure/Migrations/UserDbContextModelSnapshot.cs">
// <auto-generated />
using System;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;
using UserService.Infrastructure.Data;

#nullable disable

namespace UserService.Infrastructure.Migrations
{
    [DbContext(typeof(UserDbContext))]
    partial class UserDbContextModelSnapshot : ModelSnapshot
    {
        protected override void BuildModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "8.0.21")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("UserService.Domain.Entities.User", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Email")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("FullName")
                        .IsRequired()
                        .HasMaxLength(150)
                        .HasColumnType("character varying(150)");

                    b.Property<string>("PasswordHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("Username")
                        .IsRequired()
                        .HasMaxLength(320)
                        .HasColumnType("character varying(320)");

                    b.HasKey("Id");

                    b.HasIndex("Email")
                        .IsUnique();

                    b.ToTable("Users");
                });
#pragma warning restore 612, 618
        }
    }
}
</file>

<file path="UserService/UserService.Infrastructure/Repositories/EfUserRepository.cs">
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using UserService.Application.Abstractions;
using UserService.Domain.Entities;
using UserService.Infrastructure.Data;

namespace UserService.Infrastructure.Repositories
{
    public sealed class EfUserRepository : IUserRepository
    {
        private readonly UserDbContext _db;
        public EfUserRepository(UserDbContext db) => _db = db;

        public Task<User?> GetByEmailAsync(string email, CancellationToken ct = default)
        {
            return _db.Users.AsNoTracking().FirstOrDefaultAsync(u => u.Email == email, ct);
        }

        public async Task AddAsync(User user, CancellationToken ct = default)
        {
            _db.Users.Add(user);
            await _db.SaveChangesAsync(ct);
        }
    }
}
</file>

<file path="UserService/UserService.Infrastructure/UserService.Infrastructure.csproj">
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.EntityFrameworkCore" Version="8.0.21" />
    <PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="8.0.11" />
    <PackageReference Include="System.IdentityModel.Tokens.Jwt" Version="8.14.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\UserService.Application\UserService.Application.csproj" />
    <ProjectReference Include="..\UserService.Domain\UserService.Domain.csproj" />
  </ItemGroup>

</Project>
</file>

<file path="UserService/UserService.sln">
Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.14.36518.9
MinimumVisualStudioVersion = 10.0.40219.1
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "UserService.Api", "UserService.Api\UserService.Api.csproj", "{7353752D-6DEF-4847-82F1-027DD460F745}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "UserService.Domain", "UserService.Domain\UserService.Domain.csproj", "{7057D391-F657-401D-8218-C5A5413CE1E5}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "UserService.Infrastructure", "UserService.Infrastructure\UserService.Infrastructure.csproj", "{EDCF6A11-F0AA-4BF0-991C-A9D385BFC9A2}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "UserService.Application", "UserService.Application\UserService.Application.csproj", "{B5872044-F672-46C1-B777-FB9A502D6C1A}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Release|Any CPU = Release|Any CPU
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{7353752D-6DEF-4847-82F1-027DD460F745}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{7353752D-6DEF-4847-82F1-027DD460F745}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{7353752D-6DEF-4847-82F1-027DD460F745}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{7353752D-6DEF-4847-82F1-027DD460F745}.Release|Any CPU.Build.0 = Release|Any CPU
		{7057D391-F657-401D-8218-C5A5413CE1E5}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{7057D391-F657-401D-8218-C5A5413CE1E5}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{7057D391-F657-401D-8218-C5A5413CE1E5}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{7057D391-F657-401D-8218-C5A5413CE1E5}.Release|Any CPU.Build.0 = Release|Any CPU
		{EDCF6A11-F0AA-4BF0-991C-A9D385BFC9A2}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{EDCF6A11-F0AA-4BF0-991C-A9D385BFC9A2}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{EDCF6A11-F0AA-4BF0-991C-A9D385BFC9A2}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{EDCF6A11-F0AA-4BF0-991C-A9D385BFC9A2}.Release|Any CPU.Build.0 = Release|Any CPU
		{B5872044-F672-46C1-B777-FB9A502D6C1A}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{B5872044-F672-46C1-B777-FB9A502D6C1A}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{B5872044-F672-46C1-B777-FB9A502D6C1A}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{B5872044-F672-46C1-B777-FB9A502D6C1A}.Release|Any CPU.Build.0 = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {0F0C31B9-E355-4B1D-A804-D93A3EE177EF}
	EndGlobalSection
EndGlobal
</file>

<file path="ApiGateway/ApiGateway/Program.cs">
var builder = WebApplication.CreateBuilder(args);

// Add services to the container.

builder.Services.AddControllers();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();
builder.Services.AddReverseProxy()
    .LoadFromConfig(builder.Configuration.GetSection("ReverseProxy"));
builder.Services.AddHealthChecks(); 
builder.Logging.ClearProviders();
builder.Logging.AddConsole();
var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

/*app.UseHttpsRedirection();*/

app.UseAuthorization();

app.MapReverseProxy();

app.MapControllers();

app.MapHealthChecks("/health");

app.Run();
</file>

<file path="DriverService/DriverService.Api/Grpc/DriverQueryService.cs">
using Driver;
using Grpc.Core;
using StackExchange.Redis;

namespace DriverService.Api.Grpc
{
    public class DriverQueryService : DriverQuery.DriverQueryBase
    {
        private readonly IConnectionMultiplexer _redis;

        public DriverQueryService(IConnectionMultiplexer redis)
        {
            _redis = redis;
        }

        public override async Task<GetDriverInfoResponse> GetDriverInfo(GetDriverInfoRequest request, ServerCallContext context)
        {
            var db = _redis.GetDatabase();
            var key = $"driver:{request.DriverId}";
            var hash = await db.HashGetAllAsync(key);

            if (hash == null || hash.Length == 0)
            {
                throw new RpcException(new Status(StatusCode.NotFound, "Driver not found"));
            }

            var latStr = hash.FirstOrDefault(x => x.Name == "lat").Value;
            var lngStr = hash.FirstOrDefault(x => x.Name == "lng").Value;
            var availStr = hash.FirstOrDefault(x => x.Name == "available").Value;
            var nameStr = hash.FirstOrDefault(x => x.Name == "name").Value;

            return new GetDriverInfoResponse
            {
                DriverId = request.DriverId,
                Name = nameStr.HasValue ? nameStr.ToString() : "",
                Lat = latStr.HasValue ? double.Parse(latStr!) : 0,
                Lng = lngStr.HasValue ? double.Parse(lngStr!) : 0,
                Available = availStr == "1"
            };
        }

        public override async Task<MarkTripAssignedResponse> MarkTripAssigned(MarkTripAssignedRequest request, ServerCallContext context)
        {
            var db = _redis.GetDatabase();
            var key = $"driver:{request.DriverId}";

            // đánh dấu tài xế bận
            await db.HashSetAsync(key, new HashEntry[] {
                new HashEntry("available", "0"),
                new HashEntry("current_trip_id", request.TripId)
            });

            return new MarkTripAssignedResponse { Success = true };
        }
    }
}
</file>

<file path="DriverService/DriverService.Application/Abstractions/IDriverRepository.cs">
namespace DriverService.Application.Abstractions
{
    public interface IDriverRepository
    {
        Task<DriverService.Domain.Domain.Driver?> GetAsync(Guid id, CancellationToken ct = default);
        Task UpsertAsync(DriverService.Domain.Domain.Driver driver, CancellationToken ct = default);
    }

}
</file>

<file path="DriverService/DriverService.Application/DriverService.Application.csproj">
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Google.Protobuf" Version="3.33.0" />
    <PackageReference Include="Grpc.Core" Version="2.46.6" />
    <PackageReference Include="Grpc.Tools" Version="2.46.6">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="StackExchange.Redis" Version="2.9.32" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\DriverService.Domain\DriverService.Domain.csproj" />
	  <Protobuf Include="Protos\driver.proto" GrpcServices="Server" ProtoRoot="Protos" />
  </ItemGroup>

</Project>
</file>

<file path="DriverService/DriverService.Application/Services/DriverLocationService.cs">
using StackExchange.Redis;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace DriverService.Application.Services
{
    public class DriverLocationService
    {
        private readonly IConnectionMultiplexer _redis;
        private static readonly CultureInfo C = CultureInfo.InvariantCulture;
        private const string GEO_KEY = "drivers:online";

        public DriverLocationService(IConnectionMultiplexer redis) => _redis = redis;

        public async Task SetOnlineAsync(Guid driverId, string name, double lat, double lng)
        {
            var db = _redis.GetDatabase();
            await db.GeoAddAsync(GEO_KEY, longitude: lng, latitude: lat, member: driverId.ToString());
            await db.HashSetAsync($"driver:{driverId}", new HashEntry[] {
            new("name", name ?? ""),
            new("online", "1"),
            new("available", "1"),
            new("lat", lat.ToString(C)),
            new("lng", lng.ToString(C)),
            new("current_trip_id", "")
        });
        }

        public async Task UpdateLocationAsync(Guid driverId, double lat, double lng)
        {
            var db = _redis.GetDatabase();
            await db.GeoAddAsync(GEO_KEY, longitude: lng, latitude: lat, member: driverId.ToString());
            await db.HashSetAsync($"driver:{driverId}", new HashEntry[] {
            new("lat", lat.ToString(C)),
            new("lng", lng.ToString(C))
        });
        }

        public async Task SetOfflineAsync(Guid driverId)
        {
            var db = _redis.GetDatabase();
            await db.HashSetAsync($"driver:{driverId}", new HashEntry[] {
            new("online", "0"),
            new("available", "0"),
            new("current_trip_id", "")
        });
            // tuỳ chọn: await db.GeoRemoveAsync(GEO_KEY, driverId.ToString());
        }

        public async Task<bool> AssignTripAsync(Guid driverId, Guid tripId)
        {
            var db = _redis.GetDatabase();
            if (await db.HashGetAsync($"driver:{driverId}", "available") != "1") return false;
            await db.HashSetAsync($"driver:{driverId}", new HashEntry[] {
            new("available", "0"),
            new("current_trip_id", tripId.ToString())
        });
            return true;
        }
    }
}
</file>

<file path="DriverService/DriverService.Domain/DriverService.Domain.csproj">
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Google.Protobuf" Version="3.33.0" />
    <PackageReference Include="Grpc.Core" Version="2.46.6" />
    <PackageReference Include="Grpc.Tools" Version="2.46.6">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="StackExchange.Redis" Version="2.9.32" />
  </ItemGroup>

</Project>
</file>

<file path="DriverService/DriverService.Infrastructure/Data/DriverDbContext.cs">
using Microsoft.EntityFrameworkCore;


namespace DriverService.Infrastructure.Data
{
    public class DriverDbContext : DbContext
    {
        public DriverDbContext(DbContextOptions<DriverDbContext> opt) : base(opt) { }

        public DbSet<DriverService.Domain.Domain.Driver> Drivers => Set<DriverService.Domain.Domain.Driver>();

        protected override void OnModelCreating(ModelBuilder b)
        {
            b.Entity<DriverService.Domain.Domain.Driver>(e =>
            {
                e.HasKey(x => x.Id);
                e.Property(x => x.FullName).HasMaxLength(150);
                e.Property(x => x.Online);
                e.Property(x => x.Lat);
                e.Property(x => x.Lng);
            });
        }
    }
}
</file>

<file path="DriverService/DriverService.Infrastructure/DriverService.Infrastructure.csproj">
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Google.Protobuf" Version="3.33.0" />
    <PackageReference Include="Grpc.Core" Version="2.46.6" />
    <PackageReference Include="Grpc.Tools" Version="2.46.6">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.EntityFrameworkCore" Version="8.0.21" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.21">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.21">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="8.0.11" />
    <PackageReference Include="StackExchange.Redis" Version="2.9.32" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\DriverService.Application\DriverService.Application.csproj" />
    <ProjectReference Include="..\DriverService.Domain\DriverService.Domain.csproj" />
  </ItemGroup>

</Project>
</file>

<file path="DriverService/DriverService.Infrastructure/Repositories/EfDriverRepository.cs">
using DriverService.Application.Abstractions;
using DriverService.Domain.Domain;
using DriverService.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace DriverService.Infrastructure.Repositories
{
    public sealed class EfDriverRepository : IDriverRepository
    {
        private readonly DriverDbContext _db;
        public EfDriverRepository(DriverDbContext db) => _db = db;

        public Task<DriverService.Domain.Domain.Driver?> GetAsync(Guid id, CancellationToken ct = default) =>
            _db.Drivers.AsNoTracking().FirstOrDefaultAsync(x => x.Id == id, ct);

        public async Task UpsertAsync(DriverService.Domain.Domain.Driver driver, CancellationToken ct = default)
        {
            var exist = await _db.Drivers.FirstOrDefaultAsync(x => x.Id == driver.Id, ct);
            if (exist is null)
                _db.Drivers.Add(driver);
            else
                _db.Entry(exist).CurrentValues.SetValues(driver);

            await _db.SaveChangesAsync(ct);
        }
    }
}
</file>

<file path="LICENSE">
MIT License

Copyright (c) 2025 Straight Forward - Helios - NHOANGHIEN

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</file>

<file path="Message/Messaging.Contracts/Routing/Routing.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Messaging.Contracts.Routing
{
    public static class Routing
    {
        public const string Exchange = "uitgo.events";

        public static class Keys
        {
            // Trips
            public const string TripCreated  = "trip.created";  
            public const string TripAssigned = "trip.assigned";
            public const string TripRequested = "trip.requested";
            public const string TripCanceled = "trip.canceled";
            public const string TripAccepted = "trip.accepted"; 
            public const string TripOffered = "trip.offered";
            public const string TripOfferDeclined = "trip.offer.declined";

            // Drivers
            public const string DriverStatusChanged = "driver.status.changed";
            public const string DriverLocationUpdated = "driver.location.updated";
            public const string DriverAssignedToTrip  = "driver.assignedToTrip";
        }
    }

}
</file>

<file path="Message/Messaging.RabbitMQ/Infrastructure/RabbitMqPublisher.cs">
using Messaging.RabbitMQ.Abstractions;
using Messaging.RabbitMQ.Config;
using Microsoft.Extensions.Options;
using RabbitMQ.Client;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;

namespace Messaging.RabbitMQ.Infrastructure
{
    public sealed class RabbitMqPublisher : IEventPublisher, IDisposable
    {
        private readonly IConnection _conn;
        private readonly IModel _ch;
        private readonly string _exchangeName;

        public RabbitMqPublisher(IOptions<RabbitMqOptions> opt, string exchangeName)
        {
            _exchangeName = exchangeName;

            var o = opt.Value;
            var factory = new ConnectionFactory
            {
                HostName = o.HostName,
                Port = o.Port,
                UserName = o.UserName,
                Password = o.Password,
                VirtualHost = o.VirtualHost,
                ClientProvidedName = $"{o.ClientName}-publisher",
                DispatchConsumersAsync = true
            };
            _conn = factory.CreateConnection();
            _ch = _conn.CreateModel();
            _ch.ExchangeDeclare(exchangeName, ExchangeType.Topic, durable: true);
        }

        public Task PublishAsync<T>(string routingKey, T payload, CancellationToken ct = default)
        {
            // Dùng cùng options như consumer (camelCase, ignore null)
            var json = JsonSerializer.Serialize(payload, JsonSerializerSettings.Default);
            var body = Encoding.UTF8.GetBytes(json);

            var props = _ch.CreateBasicProperties();
            props.ContentType = "application/json";
            props.DeliveryMode = 2;

            _ch.BasicPublish(exchange: _exchangeName, routingKey: routingKey, basicProperties: props, body: body);
            return Task.CompletedTask;
        }

        public void Dispose()
        {
            _ch?.Dispose();
            _conn?.Dispose();
        }
    }
}
</file>

<file path="TripService/TripService.Api/Controllers/TripsController.cs">
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using TripService.Application.Abstractions;
using TripService.Domain.Entities;

namespace TripService.Api.Controllers
{
    [Route("api/trips")]
    [ApiController]
    public class TripsController : ControllerBase
    {
        private readonly ITripService _tripService;
        public TripsController(ITripService svc) => _tripService = svc;

        [HttpPost]
        public async Task<IActionResult> Create([FromBody] CreateTripRequest req, CancellationToken ct)
        {
            // TODO: sau này lấy từ JWT (user id). Hiện tại tạm hardcode.
            var passengerId = Guid.NewGuid();

            var trip = new Trip
            {
                Id = Guid.NewGuid(),
                PassengerId = passengerId,
                StartLat = req.PickupLat,
                StartLng = req.PickupLng,
                EndLat = req.DropoffLat,
                EndLng = req.DropoffLng,
                // Status sẽ set ở CreateAsync
            };

            var created = await _tripService.CreateAsync(trip, ct);

            return Ok(created);
        }

        [HttpGet("{id:guid}")]
        public async Task<IActionResult> Get(Guid id, CancellationToken ct)
        {
            var result = await _tripService.GetAsync(id, ct);
            if (result is null) return NotFound();
            return Ok(result);
        }

        [HttpPost("{id:guid}/cancel")]
        public async Task<IActionResult> Cancel(Guid id, CancellationToken ct)
        {
            await _tripService.CancelAsync(id, ct);
            return NoContent();
        }

        [HttpGet("health")]
        public IActionResult Health() => Ok("trip ok");

    }
}
</file>

<file path="TripService/TripService.Domain/Entities/Trip.cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace TripService.Domain.Entities
{
    public enum TripStatus { Pending, Searching, Accepted, InProgress, Completed, Canceled }

    public class Trip
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public Guid PassengerId { get; set; }
        public Guid? AssignedDriverId { get; set; }
        public double StartLat { get; set; }
        public double StartLng { get; set; }
        public double EndLat { get; set; }
        public double EndLng { get; set; }
        public TripStatus Status { get; set; } = TripStatus.Pending;
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    }
}
</file>

<file path="TripService/TripService.Domain/TripService.Domain.csproj">
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Google.Protobuf" Version="3.33.0" />
    <PackageReference Include="Grpc.Core" Version="2.46.6" />
    <PackageReference Include="Grpc.Net.Client" Version="2.71.0" />
    <PackageReference Include="Grpc.Net.ClientFactory" Version="2.71.0" />
    <PackageReference Include="Grpc.Tools" Version="2.76.0">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="StackExchange.Redis" Version="2.9.32" />
  </ItemGroup>

</Project>
</file>

<file path="TripService/TripService.Infrastructure/Data/TripDbContext.cs">
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using TripService.Domain.Entities;

namespace TripService.Infrastructure.Data
{
    public class TripDbContext : DbContext
    {
        public TripDbContext(DbContextOptions<TripDbContext> opt) : base(opt) { }
        public DbSet<Trip> Trips { get; set; }
        protected override void OnModelCreating(ModelBuilder b)
        {
            b.Entity<Trip>(e =>
            {
                e.HasKey(x => x.Id);

                e.Property(x => x.PassengerId).IsRequired();

                e.Property(x => x.Status)
                    .HasConversion<string>()
                    .IsRequired();

                // Phase 2 có thể refactor thành GeoPoint VO
                e.Property(x => x.StartLat).IsRequired();
                e.Property(x => x.StartLng).IsRequired();
                e.Property(x => x.EndLat).IsRequired();
                e.Property(x => x.EndLng).IsRequired();
            });
        }
    }
}
</file>

<file path="TripService/TripService.Infrastructure/Migrations/TripDbContextModelSnapshot.cs">
// <auto-generated />
using System;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;
using TripService.Infrastructure.Data;

#nullable disable

namespace TripService.Infrastructure.Migrations
{
    [DbContext(typeof(TripDbContext))]
    partial class TripDbContextModelSnapshot : ModelSnapshot
    {
        protected override void BuildModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "8.0.21")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("TripService.Domain.Entities.Trip", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<Guid?>("AssignedDriverId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<double>("EndLat")
                        .HasColumnType("double precision");

                    b.Property<double>("EndLng")
                        .HasColumnType("double precision");

                    b.Property<Guid>("PassengerId")
                        .HasColumnType("uuid");

                    b.Property<double>("StartLat")
                        .HasColumnType("double precision");

                    b.Property<double>("StartLng")
                        .HasColumnType("double precision");

                    b.Property<string>("Status")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Trips");
                });
#pragma warning restore 612, 618
        }
    }
}
</file>

<file path="TripService/TripService.Infrastructure/TripService.Infrastructure.csproj">
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Google.Protobuf" Version="3.33.0" />
    <PackageReference Include="Grpc.Core" Version="2.46.6" />
    <PackageReference Include="Grpc.Net.Client" Version="2.71.0" />
    <PackageReference Include="Grpc.Net.ClientFactory" Version="2.71.0" />
    <PackageReference Include="Grpc.Tools" Version="2.76.0">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.21">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.21">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="8.0.11" />
    <PackageReference Include="StackExchange.Redis" Version="2.9.32" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\TripService.Application\TripService.Application.csproj" />
    <ProjectReference Include="..\TripService.Domain\TripService.Domain.csproj" />
  </ItemGroup>

</Project>
</file>

<file path="UserService/UserService.Api/appsettings.json">
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "Jwt": {
    "Secret": "UltimateSuperSecretKeyForJwtTokenGeneration123",
    "Issuer": "UserService",
    "Audience": "UserServiceClients",
    "ExpirationInMinutes": 60
  },
  "ConnectionStrings": {
    "Default": "Host=localhost;Port=5433;Database=uitgo_user;Username=postgres;Password=postgres",
    "Redis": "localhost:6379"
  }
}
</file>

<file path="UserService/UserService.Api/Controllers/AuthController.cs">
using Microsoft.AspNetCore.Mvc;
using UserService.Application.Abstractions;
using UserService.Application.Dtos;

namespace UserService.Api.Controllers
{
    [ApiController]
    [Route("api/users")]
    public class AuthController : ControllerBase
    {
        private readonly IAuthService _authService;
        public AuthController(IAuthService authService) => _authService = authService;

        [HttpPost("register")]
        public async Task<IActionResult> Register([FromBody] RegisterDto dto, CancellationToken ct)
        {
            var u = await _authService.RegisterAsync(dto.Email, dto.Password, dto.FullName, ct);
            return Ok(new { u.Id, u.Email, u.FullName });
        }

        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginDto dto, CancellationToken ct)
        {
            var token = await _authService.LoginAsync(dto.Email, dto.Password, ct);
            return Ok(new { token });
        }

        [HttpGet("health")]
        public IActionResult Health() => Ok("user ok");
    }
}
</file>

<file path="UserService/UserService.Api/Program.cs">
using Microsoft.EntityFrameworkCore;
using System;
using UserService.Application.Abstractions;
using UserService.Application.Services;
using UserService.Infrastructure.Auth;
using UserService.Infrastructure.Data;
using UserService.Infrastructure.Repositories;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.

builder.Services.AddControllers();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();
builder.Services.Configure<JwtSettings>(
    builder.Configuration.GetSection("Jwt")
);
builder.Services.AddDbContext<UserDbContext>(opt =>
    opt.UseNpgsql(builder.Configuration.GetConnectionString("Default")));
builder.Services.AddScoped<IUserRepository, EfUserRepository>();
builder.Services.AddScoped<IJwtTokenProvider, JwtTokenProvider>();
builder.Services.AddScoped<IAuthService, AuthService>();
builder.Services.AddHealthChecks();
var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();

app.UseAuthorization();

app.MapControllers();

app.MapHealthChecks("/health");

using (var scope = app.Services.CreateScope())
{
    var db = scope.ServiceProvider.GetRequiredService<UserDbContext>();
    db.Database.Migrate();
}

app.Run();
</file>

<file path="DriverService/DriverService.Api/DriverService.Api.csproj">
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Google.Protobuf" Version="3.33.0" />
    <PackageReference Include="Grpc.AspNetCore" Version="2.71.0" />
    <PackageReference Include="Grpc.Core" Version="2.46.6" />
    <PackageReference Include="Grpc.Tools" Version="2.76.0">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.21">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="8.0.11" />
    <PackageReference Include="StackExchange.Redis" Version="2.9.32" />
    <PackageReference Include="Swashbuckle.AspNetCore" Version="6.6.2" />
  </ItemGroup>

  <ItemGroup>
	  <ProjectReference Include="..\..\Message\Messaging.Contracts\Messaging.Contracts.csproj" />
	  <ProjectReference Include="..\..\Message\Messaging.RabbitMQ\Messaging.RabbitMQ.csproj" />
	  <ProjectReference Include="..\DriverService.Application\DriverService.Application.csproj" />
        <ProjectReference Include="..\DriverService.Infrastructure\DriverService.Infrastructure.csproj" />
  </ItemGroup>

</Project>
</file>

<file path="DriverService/DriverService.Application/Services/DriverService.cs">
using DriverService.Application.Abstractions;


namespace DriverService.Application.Services
{
    public sealed class DriverService : IDriverService
    {
        private readonly IDriverRepository _repo;
        private readonly DriverLocationService _locationSvc;

        public DriverService(IDriverRepository repo, DriverLocationService locationSvc)
        {
            _repo = repo;
            _locationSvc = locationSvc;
        }

        public async Task SetOnlineAsync(Guid id, bool online, CancellationToken ct = default)
        {
            var d = await _repo.GetAsync(id, ct) ?? new Domain.Domain.Driver { Id = id };
            d.Online = online;
            d.UpdatedAt = DateTime.UtcNow;
            await _repo.UpsertAsync(d, ct);

            if (online)
            {
                // Lấy tên + toạ độ hiện có trong DB để seed vào Redis
                await _locationSvc.SetOnlineAsync(id, d.FullName ?? "", d.Lat, d.Lng);
            }
            else
            {
                await _locationSvc.SetOfflineAsync(id);
            }
        }

        public async Task UpdateLocationAsync(Guid id, double lat, double lng, CancellationToken ct = default)
        {
            var d = await _repo.GetAsync(id, ct) ?? new Domain.Domain.Driver { Id = id };
            d.Lat = lat;
            d.Lng = lng;
            d.UpdatedAt = DateTime.UtcNow;

            await _repo.UpsertAsync(d, ct);

            // đẩy vị trí (lng,lat) vào Redis GEO
            await _locationSvc.UpdateLocationAsync(id, lat, lng);
        }
    }
}
</file>

<file path="DriverService/DriverService.sln">
Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.14.36518.9
MinimumVisualStudioVersion = 10.0.40219.1
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "DriverService.Api", "DriverService.Api\DriverService.Api.csproj", "{744A0F5B-BB24-4446-B760-50ED1C96133E}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "DriverService.Application", "DriverService.Application\DriverService.Application.csproj", "{F573D397-C45E-4D3E-ABC4-D016F5D775BA}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "DriverService.Domain", "DriverService.Domain\DriverService.Domain.csproj", "{58D2A7EB-1E5F-43D5-AFA1-7FF8097EB67C}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "DriverService.Infrastructure", "DriverService.Infrastructure\DriverService.Infrastructure.csproj", "{65292C7E-ACFF-4216-B78F-DED0DA81A645}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Shared", "..\Shared\Shared\Shared.csproj", "{626B1D52-BBD1-11BC-B02F-BAA61CE5EAB1}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Messaging.Contracts", "..\Message\Messaging.Contracts\Messaging.Contracts.csproj", "{503D8180-4654-67C6-CE04-ED791911EB88}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Messaging.RabbitMQ", "..\Message\Messaging.RabbitMQ\Messaging.RabbitMQ.csproj", "{4778618A-EE5D-E2BD-91B6-A83B5604CAEE}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Release|Any CPU = Release|Any CPU
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{744A0F5B-BB24-4446-B760-50ED1C96133E}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{744A0F5B-BB24-4446-B760-50ED1C96133E}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{744A0F5B-BB24-4446-B760-50ED1C96133E}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{744A0F5B-BB24-4446-B760-50ED1C96133E}.Release|Any CPU.Build.0 = Release|Any CPU
		{F573D397-C45E-4D3E-ABC4-D016F5D775BA}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{F573D397-C45E-4D3E-ABC4-D016F5D775BA}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{F573D397-C45E-4D3E-ABC4-D016F5D775BA}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{F573D397-C45E-4D3E-ABC4-D016F5D775BA}.Release|Any CPU.Build.0 = Release|Any CPU
		{58D2A7EB-1E5F-43D5-AFA1-7FF8097EB67C}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{58D2A7EB-1E5F-43D5-AFA1-7FF8097EB67C}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{58D2A7EB-1E5F-43D5-AFA1-7FF8097EB67C}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{58D2A7EB-1E5F-43D5-AFA1-7FF8097EB67C}.Release|Any CPU.Build.0 = Release|Any CPU
		{65292C7E-ACFF-4216-B78F-DED0DA81A645}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{65292C7E-ACFF-4216-B78F-DED0DA81A645}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{65292C7E-ACFF-4216-B78F-DED0DA81A645}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{65292C7E-ACFF-4216-B78F-DED0DA81A645}.Release|Any CPU.Build.0 = Release|Any CPU
		{503D8180-4654-67C6-CE04-ED791911EB88}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{503D8180-4654-67C6-CE04-ED791911EB88}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{503D8180-4654-67C6-CE04-ED791911EB88}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{503D8180-4654-67C6-CE04-ED791911EB88}.Release|Any CPU.Build.0 = Release|Any CPU
		{4778618A-EE5D-E2BD-91B6-A83B5604CAEE}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{4778618A-EE5D-E2BD-91B6-A83B5604CAEE}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{4778618A-EE5D-E2BD-91B6-A83B5604CAEE}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{4778618A-EE5D-E2BD-91B6-A83B5604CAEE}.Release|Any CPU.Build.0 = Release|Any CPU
		{626B1D52-BBD1-11BC-B02F-BAA61CE5EAB1}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{626B1D52-BBD1-11BC-B02F-BAA61CE5EAB1}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{626B1D52-BBD1-11BC-B02F-BAA61CE5EAB1}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{626B1D52-BBD1-11BC-B02F-BAA61CE5EAB1}.Release|Any CPU.Build.0 = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {1C9C4761-C651-42DC-BD3E-6CC79B5FA2D5}
	EndGlobalSection
EndGlobal
</file>

<file path="TripService/TripService.Api/Program.cs">
using Driver;
using Messaging.Contracts.Routing;
using Messaging.RabbitMQ;
using Microsoft.EntityFrameworkCore;
using StackExchange.Redis;
using TripService.Api.Messaging;
using TripService.Application.Abstractions;
using TripService.Application.Offers;
using TripService.Application.Services;
using TripService.Infrastructure.Data;
using TripService.Infrastructure.Repositories;

AppContext.SetSwitch("System.Net.Http.SocketsHttpHandler.Http2UnencryptedSupport", true);

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.

builder.Services
    .AddControllers()
    .AddJsonOptions(o =>
    {
        o.JsonSerializerOptions.Converters.Add(
            new System.Text.Json.Serialization.JsonStringEnumConverter()
        );
    });
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddDbContext<TripDbContext>(opt =>
    opt.UseNpgsql(builder.Configuration.GetConnectionString("Default")));
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();
builder.Services.AddScoped<ITripRepository, EfTripRepository>();
builder.Services.AddScoped<ITripService, TripService.Application.Services.TripService>();

builder.Services.AddRabbitMqEventBus(builder.Configuration, Routing.Exchange);
builder.Services.AddScoped<TripMatchService>();
builder.Services.AddSingleton<IConnectionMultiplexer>(
    ConnectionMultiplexer.Connect(builder.Configuration.GetConnectionString("Redis"))
);

builder.Services.AddScoped<IOfferStore, RedisOfferStore>();

builder.Services.AddHostedService<TripOfferDeclinedConsumer>();
builder.Services.AddHostedService<TripOfferedConsumer>();

builder.Services.AddGrpcClient<DriverQuery.DriverQueryClient>(o =>
{
    // khớp với service name "driver-service" trong docker-compose
    // và port nội bộ 8080 (vì DriverService listen http://+:8080)
    o.Address = new Uri("http://driver-service:8080");
});

builder.Services.AddHealthChecks();
var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();

app.UseAuthorization();

app.MapControllers();

app.MapHealthChecks("/health");

using (var scope = app.Services.CreateScope())
{
    var db = scope.ServiceProvider.GetRequiredService<TripDbContext>();
    db.Database.Migrate();
}

app.Run();
</file>

<file path="TripService/TripService.Api/TripService.Api.csproj">
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Google.Protobuf" Version="3.33.0" />
    <PackageReference Include="Grpc.Core" Version="2.46.6" />
    <PackageReference Include="Grpc.Net.Client" Version="2.71.0" />
    <PackageReference Include="Grpc.Net.ClientFactory" Version="2.71.0" />
    <PackageReference Include="Grpc.Tools" Version="2.76.0">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.21">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="StackExchange.Redis" Version="2.9.32" />
    <PackageReference Include="Swashbuckle.AspNetCore" Version="6.6.2" />
	<PackageReference Include="Microsoft.EntityFrameworkCore" Version="8.0.21" />
	<PackageReference Include="Microsoft.EntityFrameworkCore.Relational" Version="8.0.21" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\..\Message\Messaging.Contracts\Messaging.Contracts.csproj" />
    <ProjectReference Include="..\..\Message\Messaging.RabbitMQ\Messaging.RabbitMQ.csproj" />
    <ProjectReference Include="..\TripService.Application\TripService.Application.csproj" />
    <ProjectReference Include="..\TripService.Infrastructure\TripService.Infrastructure.csproj" />
  </ItemGroup>

</Project>
</file>

<file path="TripService/TripService.Application/TripService.Application.csproj">
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Google.Protobuf" Version="3.33.0" />
    <PackageReference Include="Grpc.Core" Version="2.46.6" />
    <PackageReference Include="Grpc.Net.Client" Version="2.71.0" />
    <PackageReference Include="Grpc.Net.ClientFactory" Version="2.71.0" />
    <PackageReference Include="Grpc.Tools" Version="2.76.0">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="StackExchange.Redis" Version="2.9.32" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\..\Message\Messaging.Contracts\Messaging.Contracts.csproj" />
    <ProjectReference Include="..\..\Message\Messaging.RabbitMQ\Messaging.RabbitMQ.csproj" />
    <ProjectReference Include="..\TripService.Domain\TripService.Domain.csproj" />
	  <Protobuf Include="Protos\driver.proto" GrpcServices="Client" ProtoRoot="Protos" />

  </ItemGroup>

</Project>
</file>

<file path="TripService/TripService.sln">
Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.14.36518.9
MinimumVisualStudioVersion = 10.0.40219.1
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "TripService.Api", "TripService.Api\TripService.Api.csproj", "{EB06143D-686E-46E8-AC22-748E5EC1A3E5}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "TripService.Infrastructure", "TripService.Infrastructure\TripService.Infrastructure.csproj", "{2A8B99F4-37B8-4A5E-B068-459BDA522EB8}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "TripService.Domain", "TripService.Domain\TripService.Domain.csproj", "{727B68CA-89FE-45BE-9EC6-DBC19838A17F}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "TripService.Application", "TripService.Application\TripService.Application.csproj", "{C5EDE0C8-04B5-4355-9C0F-DA9AE9256F96}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Messaging.Contracts", "..\Message\Messaging.Contracts\Messaging.Contracts.csproj", "{503D8180-4654-67C6-CE04-ED791911EB88}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Messaging.RabbitMQ", "..\Message\Messaging.RabbitMQ\Messaging.RabbitMQ.csproj", "{4778618A-EE5D-E2BD-91B6-A83B5604CAEE}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Shared", "..\Shared\Shared\Shared.csproj", "{626B1D52-BBD1-11BC-B02F-BAA61CE5EAB1}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Release|Any CPU = Release|Any CPU
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{EB06143D-686E-46E8-AC22-748E5EC1A3E5}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{EB06143D-686E-46E8-AC22-748E5EC1A3E5}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{EB06143D-686E-46E8-AC22-748E5EC1A3E5}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{EB06143D-686E-46E8-AC22-748E5EC1A3E5}.Release|Any CPU.Build.0 = Release|Any CPU
		{2A8B99F4-37B8-4A5E-B068-459BDA522EB8}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{2A8B99F4-37B8-4A5E-B068-459BDA522EB8}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{2A8B99F4-37B8-4A5E-B068-459BDA522EB8}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{2A8B99F4-37B8-4A5E-B068-459BDA522EB8}.Release|Any CPU.Build.0 = Release|Any CPU
		{727B68CA-89FE-45BE-9EC6-DBC19838A17F}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{727B68CA-89FE-45BE-9EC6-DBC19838A17F}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{727B68CA-89FE-45BE-9EC6-DBC19838A17F}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{727B68CA-89FE-45BE-9EC6-DBC19838A17F}.Release|Any CPU.Build.0 = Release|Any CPU
		{C5EDE0C8-04B5-4355-9C0F-DA9AE9256F96}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{C5EDE0C8-04B5-4355-9C0F-DA9AE9256F96}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{C5EDE0C8-04B5-4355-9C0F-DA9AE9256F96}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{C5EDE0C8-04B5-4355-9C0F-DA9AE9256F96}.Release|Any CPU.Build.0 = Release|Any CPU
		{503D8180-4654-67C6-CE04-ED791911EB88}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{503D8180-4654-67C6-CE04-ED791911EB88}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{503D8180-4654-67C6-CE04-ED791911EB88}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{503D8180-4654-67C6-CE04-ED791911EB88}.Release|Any CPU.Build.0 = Release|Any CPU
		{4778618A-EE5D-E2BD-91B6-A83B5604CAEE}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{4778618A-EE5D-E2BD-91B6-A83B5604CAEE}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{4778618A-EE5D-E2BD-91B6-A83B5604CAEE}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{4778618A-EE5D-E2BD-91B6-A83B5604CAEE}.Release|Any CPU.Build.0 = Release|Any CPU
		{626B1D52-BBD1-11BC-B02F-BAA61CE5EAB1}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{626B1D52-BBD1-11BC-B02F-BAA61CE5EAB1}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{626B1D52-BBD1-11BC-B02F-BAA61CE5EAB1}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{626B1D52-BBD1-11BC-B02F-BAA61CE5EAB1}.Release|Any CPU.Build.0 = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {BFF94CFB-2892-4EAB-B3FC-CE20F7456FDE}
	EndGlobalSection
EndGlobal
</file>

<file path="docker-compose.yml">
services:
  user-service:
    build:
      context: .
      dockerfile: ./deploy/docker/UserService.Dockerfile
    ports: ["5001:8080"]
    environment:
      # Postgres
      - ConnectionStrings__Default=Host=postgres-user;Port=5432;Database=uitgo_user;Username=postgres;Password=postgres
      # Redis
      - ConnectionStrings__Redis=uit-go-redis:6379
      # JWT (giữ giá trị "mạnh" hơn từ file 2)
      - Jwt__Secret=UltimateSuperSecretKeyForJwtTokenGeneration123
      # RabbitMQ
      - RabbitMQ__HostName=rabbitmq
      - RabbitMQ__Port=5672
      - RabbitMQ__UserName=guest
      - RabbitMQ__Password=guest
    depends_on:
      postgres-user:
        condition: service_started
      rabbitmq:
        condition: service_healthy
      uit-go-redis:
        condition: service_started

  driver-service:
    build:
      context: .
      dockerfile: ./deploy/docker/DriverService.Dockerfile
    ports: ["5003:8080"]
    environment:
      # Postgres
      - ConnectionStrings__Default=Host=postgres-driver;Port=5432;Database=uitgo_driver;Username=postgres;Password=postgres
      # Redis
      - ConnectionStrings__Redis=uit-go-redis:6379
      # RabbitMQ
      - RabbitMQ__HostName=rabbitmq
      - RabbitMQ__Port=5672
      - RabbitMQ__UserName=guest
      - RabbitMQ__Password=guest
    depends_on:
      postgres-driver:
        condition: service_started
      rabbitmq:
        condition: service_healthy
      uit-go-redis:
        condition: service_started

  trip-service:
    build:
      context: .
      dockerfile: ./deploy/docker/TripService.Dockerfile
    ports: ["5002:8080"]
    environment:
      # Postgres
      - ConnectionStrings__Default=Host=postgres-trip;Port=5432;Database=uitgo_trip;Username=postgres;Password=postgres
      # Redis
      - ConnectionStrings__Redis=uit-go-redis:6379
      # RabbitMQ
      - RabbitMQ__HostName=rabbitmq
      - RabbitMQ__Port=5672
      - RabbitMQ__UserName=guest
      - RabbitMQ__Password=guest
    depends_on:
      postgres-trip:
        condition: service_started
      driver-service:
        condition: service_started
      rabbitmq:
        condition: service_healthy
      uit-go-redis:
        condition: service_started

  api-gateway:
    build:
      context: .
      dockerfile: ./deploy/docker/ApiGateway.Dockerfile
    # Nếu container gateway lắng nghe cổng 80 bên trong, giữ 8080:80 (mặc định Nginx)
    ports: ["8080:8080"]
    # Nếu gateway của bạn lắng nghe 8080 bên trong, đổi thành: ports: ["8080:8080"]
    depends_on:
      user-service:
        condition: service_started
      trip-service:
        condition: service_started
      driver-service:
        condition: service_started

  # postgres
  postgres-user:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: uitgo_user
    ports: ["5433:5432"]
    volumes:
      - pg_user:/var/lib/postgresql/data

  postgres-trip:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: uitgo_trip
    ports: ["5434:5432"]
    volumes:
      - pg_trip:/var/lib/postgresql/data

  postgres-driver:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: uitgo_driver
    ports: ["5435:5432"]
    volumes:
      - pg_driver:/var/lib/postgresql/data

  # redis
  uit-go-redis:
    image: redis:7-alpine
    command: ["redis-server","--appendonly","yes"]
    ports: ["6379:6379"]
    volumes:
      - redis-data:/data

  # rabbitmq
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: rabbitmq
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # UI
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      # RABBITMQ_DEFAULT_VHOST: /uitgo-dev   # (tùy chọn) nếu muốn dùng vhost riêng → nhớ set RabbitMQ__VirtualHost ở các service
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  pg_user: {}
  pg_trip: {}
  pg_driver: {}
  redis-data: {}
</file>

<file path="DriverService/DriverService.Api/appsettings.json">
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "Default": "Host=localhost;Port=5435;Database=uitgo_driver;Username=postgres;Password=postgres",
    "Redis": "localhost:6379"
  },
  "RabbitMQ": {
    "HostName": "localhost",
    "Port": 5672,
    "UserName": "guest",
    "Password": "guest",
    "VirtualHost": "/",
    "PrefetchCount": 50,
    "ClientName": "uitgo"
  }
}
</file>

<file path="DriverService/DriverService.Api/Controllers/DriversController.cs">
using DriverService.Application.Abstractions;
using DriverService.Application.Services;
using DriverService.Infrastructure.Data;
using Messaging.Contracts.Routing;
using Messaging.Contracts.Trips;
using Messaging.RabbitMQ.Abstractions;
using Microsoft.AspNetCore.Mvc;
using StackExchange.Redis;

namespace DriverService.Api.Controllers
{
    [ApiController]
    [Route("api/drivers")]
    public class DriversController : ControllerBase
    {
        private readonly IConnectionMultiplexer _redis;

        private readonly IDriverService _driverSvc;

        private readonly IEventPublisher _bus;

        public DriversController(IConnectionMultiplexer redis, IDriverService driverSvc, IEventPublisher bus)
        {
            _driverSvc = driverSvc;
            _redis = redis;
            _bus = bus;
        }

        // Bật online kèm tọa độ ban đầu
        [HttpPost("{id:guid}/online")]
        public async Task<IActionResult> SetOnline(Guid id, [FromBody] SetOnlineRequest req, CancellationToken ct)
        {
            // lưu lat/lng vào DB và Redis
            await _driverSvc.UpdateLocationAsync(id, req.Lat, req.Lng, ct);
            await _driverSvc.SetOnlineAsync(id, true, ct);
            return Ok(new { id, online = true });
        }

        // Cập nhật vị trí (tài xế đang online)
        [HttpPost("{id:guid}/location")]
        public async Task<IActionResult> UpdateLocation(Guid id, [FromBody] UpdateLocationRequest req, CancellationToken ct)
        {
            await _driverSvc.UpdateLocationAsync(id, req.Lat, req.Lng, ct);
            return Ok(new { id, updated = true });
        }

        [HttpPost("{driverId}/trip-finished")]
        public async Task<IActionResult> TripFinished(Guid driverId)
        {
            var dbRedis = _redis.GetDatabase();

            // đánh dấu driver available lại
            var key = $"driver:{driverId}";
            await dbRedis.HashSetAsync(key, new HashEntry[]
            {
            new HashEntry("available", "1"),
            new HashEntry("current_trip_id", "")
            });

            // (optional): update DB nếu bạn muốn log lịch sử
            // var driver = await _db.Drivers.FirstOrDefaultAsync(x => x.Id == driverId);
            // if (driver != null) { ... }
            // await _db.SaveChangesAsync();

            return Ok(new { driverId, status = "available" });
        }

        [HttpGet("search")]
        public async Task<IActionResult> Search([FromQuery] double lat, [FromQuery] double lng, [FromQuery] double radiusKm = 5, [FromQuery] int take = 10)
        {
            var db = _redis.GetDatabase();
            var results = await db.GeoRadiusAsync("drivers:geo", lng, lat, radiusKm, GeoUnit.Kilometers, count: take, order: Order.Ascending);

            var list = new List<object>();
            foreach (var r in results)
            {
                var id = r.Member.ToString();
                var hash = await db.HashGetAllAsync($"driver:{id}");
                var obj = hash.ToStringDictionary();
                list.Add(new
                {
                    driverId = id,
                    distanceKm = r.Distance ?? 0,
                    name = obj.GetValueOrDefault("name"),
                    lat = double.TryParse(obj.GetValueOrDefault("lat"), out var a) ? a : 0,
                    lng = double.TryParse(obj.GetValueOrDefault("lng"), out var b) ? b : 0,
                    available = obj.GetValueOrDefault("available") == "1"
                });
            }
            return Ok(list);
        }

        [HttpPost("{driverId:guid}/trips/{tripId:guid}/decline")]
        public async Task<IActionResult> Decline(Guid driverId, Guid tripId, CancellationToken ct)
        {
            await _bus.PublishAsync(Routing.Keys.TripOfferDeclined,
                new TripOfferDeclined(tripId, driverId), ct);

            return Accepted(new { tripId, driverId, status = "declined" });
        }

        [HttpGet("health")]
        public IActionResult Health() => Ok("driver ok");
    }

    public record UpdateLocationDto(double Lat, double Lng);
    public record SetOnlineDto(bool Online);

    public sealed class SetOnlineRequest
    {
        public double Lat { get; set; }
        public double Lng { get; set; }
    }
    public sealed class UpdateLocationRequest
    {
        public double Lat { get; set; }
        public double Lng { get; set; }
    }
}
</file>

<file path="TripService/TripService.Api/appsettings.json">
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "Default": "Host=localhost;Port=5434;Database=uitgo_trip;Username=postgres;Password=postgres",
    "Redis": "localhost:6379"
  },
  "RabbitMQ": {
    "HostName": "localhost",
    "Port": 5672,
    "UserName": "guest",
    "Password": "guest",
    "VirtualHost": "/",
    "PrefetchCount": 50,
    "ClientName": "uitgo"
  }
}
</file>

<file path="DriverService/DriverService.Api/Program.cs">
using DriverService.Api.Grpc;
using DriverService.Api.Messaging;
using DriverService.Application.Abstractions;
using DriverService.Application.Services;
using DriverService.Infrastructure.Data;
using DriverService.Infrastructure.Repositories;
using Messaging.Contracts.Routing;
using Messaging.RabbitMQ;
using Microsoft.AspNetCore.Server.Kestrel.Core;
using Microsoft.EntityFrameworkCore;
using StackExchange.Redis;

AppContext.SetSwitch("System.Net.Http.SocketsHttpHandler.Http2UnencryptedSupport", true);

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.

builder.WebHost.ConfigureKestrel(k =>
{
    // Giữ nguyên cổng gRPC h2c cho TripService
    k.ListenAnyIP(8080, o =>
    {
        o.Protocols = HttpProtocols.Http2; // gRPC (h2c)
    });

    // THÊM cổng REST HTTP/1.1 để Gateway proxy
    k.ListenAnyIP(8081, o =>
    {
        o.Protocols = HttpProtocols.Http1; // REST (HTTP/1.1)
    });
});

builder.Services.AddControllers();
builder.Services.AddGrpc();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();
builder.Services.AddDbContext<DriverDbContext>(opt =>
    opt.UseNpgsql(builder.Configuration.GetConnectionString("Default")));

builder.Services.AddScoped<IDriverRepository, EfDriverRepository>();
builder.Services.AddScoped<IDriverService, DriverService.Application.Services.DriverService>();

builder.Services.AddRabbitMqEventBus(builder.Configuration, Routing.Exchange);
builder.Services.AddHostedService<TripRequestedConsumer>();
builder.Services.AddHostedService<TripCreatedConsumer>();  
builder.Services.AddHostedService<TripAssignedConsumer>();
builder.Services.AddScoped<DriverLocationService>(); 
builder.Services.AddSingleton<IConnectionMultiplexer>(
    ConnectionMultiplexer.Connect(builder.Configuration.GetConnectionString("Redis"))
);
builder.Services.AddHealthChecks();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

//app.UseHttpsRedirection();

app.UseAuthorization();

app.MapControllers();

app.MapGrpcService<DriverQueryService>(); 

app.MapHealthChecks("/health");

// auto-migrate DB mỗi lần start
using (var scope = app.Services.CreateScope())
{
    var db = scope.ServiceProvider.GetRequiredService<DriverDbContext>();
    db.Database.Migrate();
}

app.Run();
</file>

<file path="TripService/TripService.Application/Services/TripService.cs">
using Messaging.Contracts.Common;
using Messaging.Contracts.Routing;
using Messaging.Contracts.Trips;
using Messaging.RabbitMQ.Abstractions;
using TripService.Application.Abstractions;
using TripService.Domain.Entities;

namespace TripService.Application.Services
{
    public sealed class TripService : ITripService
    {
        private readonly ITripRepository _repo;
        private readonly TripMatchService _match;
        private readonly IOfferStore _offers;
        private readonly IEventPublisher _bus;

        public TripService(ITripRepository repo, TripMatchService match, IOfferStore offers, IEventPublisher bus)
        {
            _repo = repo; _match = match; _offers = offers; _bus = bus;
        }

        public async Task<Trip> CreateAsync(Trip trip, CancellationToken ct = default)
        {
            trip.Status = TripStatus.Searching;
            await _repo.AddAsync(trip, ct);

            var createdEvt = new TripCreated(
                TripId: trip.Id,
                PassengerId: trip.PassengerId,
                Start: new GeoPoint(trip.StartLat, trip.StartLng),
                End: new GeoPoint(trip.EndLat, trip.EndLng),
                CreatedAtUtc: DateTime.UtcNow
            );
            await _bus.PublishAsync(Routing.Keys.TripCreated, createdEvt, ct);

            var candidate = await _match.FindBestDriverAsync(
                lat: trip.StartLat, lng: trip.StartLng, radiusKm: 20.0, take: 10);
            if (candidate is null) return trip;

            var locked = await _match.TryLockTripAsync(trip.Id, TimeSpan.FromSeconds(15));
            if (!locked) return trip;

            const int ttl = 15;
            await _offers.SetPendingAsync(trip.Id, candidate.DriverId, TimeSpan.FromSeconds(ttl), ct);

            var offered = new TripOffered(
                TripId: trip.Id,
                DriverId: candidate.DriverId,
                TtlSeconds: ttl
            );
            await _bus.PublishAsync(Routing.Keys.TripOffered, offered, ct);

            return trip;
        }


        public Task<Trip?> GetAsync(Guid id, CancellationToken ct = default)
            => _repo.GetAsync(id, ct);

        public async Task CancelAsync(Guid id, CancellationToken ct = default)
        {
            var t = await _repo.GetAsync(id, ct) ?? throw new KeyNotFoundException();
            t.Status = TripStatus.Canceled;
            await _repo.UpdateAsync(t, ct);
        }
    }
}

public class CreateTripRequest
{
    public double PickupLat { get; set; }
    public double PickupLng { get; set; }
    public double DropoffLat { get; set; }
    public double DropoffLng { get; set; }
}
</file>

</files>
